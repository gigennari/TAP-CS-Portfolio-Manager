<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="market-banner.js"></script>
    <style>
        .stock-logo-container {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stock-logo-container:hover {
            transform: rotate(360deg) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stock-logo-container.spin-in {
            animation: spinIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .stock-logo-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            margin: 4px; /* white border thickness */
        }

        .stock-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        @keyframes spinIn {
            0% {
                transform: rotate(-180deg) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: rotate(0deg) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        /* Staggered animation delays for multiple logos */
        .stock-logo-container:nth-child(1) { animation-delay: 0.1s; }
        .stock-logo-container:nth-child(2) { animation-delay: 0.2s; }
        .stock-logo-container:nth-child(3) { animation-delay: 0.3s; }
        .stock-logo-container:nth-child(4) { animation-delay: 0.4s; }
        .stock-logo-container:nth-child(5) { animation-delay: 0.5s; }
        .stock-logo-container:nth-child(6) { animation-delay: 0.6s; }
        .stock-logo-container:nth-child(7) { animation-delay: 0.7s; }
        .stock-logo-container:nth-child(8) { animation-delay: 0.8s; }
        .stock-logo-container:nth-child(9) { animation-delay: 0.9s; }
        .stock-logo-container:nth-child(10) { animation-delay: 1.0s; }

        /* Portfolio Overview Cards Hover Effects */
        .portfolio-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .portfolio-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .portfolio-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .portfolio-card:hover::before {
            left: 100%;
        }

        .portfolio-card .card-icon {
            transition: all 0.4s ease;
        }

        .portfolio-card:hover .card-icon {
            transform: scale(1.2) rotate(10deg);
        }

        .portfolio-card .card-value {
            transition: all 0.3s ease;
        }

        .portfolio-card:hover .card-value {
            transform: scale(1.05);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Individual card color themes */
        .portfolio-card.balance-card:hover {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
        }

        .portfolio-card.value-card:hover {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
        }

        .portfolio-card.change-card:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
        }

        .portfolio-card.assets-card:hover {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 1px solid #c4b5fd;
        }

        /* Shimmer effect for values */
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .portfolio-card:hover .shimmer-text {
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.8) 50%, transparent 100%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
            background-clip: text;
            -webkit-background-clip: text;
        }
        
        
        
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header with User Selection -->
    <header class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Portfolio Dashboard</h1>
                    <p class="text-slate-600 text-sm mt-1">Manage your investment portfolio</p>
                </div>
                
                <!-- Centered Navigation Menu -->
                <div class="absolute left-1/2 transform -translate-x-1/2">
                    <nav class="flex items-center space-x-1 bg-slate-100 rounded-lg p-1">
                        <a href="portfoliotable.html" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-medium shadow-sm">
                            Portfolio
                        </a>
                        <button onclick="openHomeBrokerPage()" class="px-4 py-2 text-slate-600 hover:text-slate-900 hover:bg-white rounded-md transition-all duration-200 font-medium">
                            Homebroker
                        </button>
                        <a href="news.html" class="px-4 py-2 text-slate-600 hover:text-slate-900 hover:bg-white rounded-md transition-all duration-200 font-medium">
                            News
                        </a>
                    </nav>
                </div>
                
                <!-- User Selection Dropdown -->
                <div class="relative">
                    <button 
                        id="userDropdownBtn" 
                        class="flex items-center space-x-3 bg-slate-100 hover:bg-slate-200 rounded-lg px-4 py-2 transition-colors"
                    >
                        <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-medium text-slate-900" id="selectedUserName">Select User</div>
                            <div class="text-xs text-slate-500" id="selectedUserEmail">No user selected</div>
                        </div>
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div 
                        id="userDropdownMenu" 
                        class="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-slate-200 z-50 hidden"
                    >
                        <div class="p-3 border-b border-slate-200">
                            <h3 class="text-sm font-medium text-slate-900">Select User</h3>
                            <p class="text-xs text-slate-500 mt-1">Choose a user to view their portfolio</p>
                        </div>
                        <div id="usersList" class="max-h-64 overflow-y-auto">
                            <!-- Users will be populated here -->
                            <div class="p-4 text-center text-slate-500">
                                <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                                <span class="text-sm">Loading users...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Portfolio Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="portfolio-card balance-card bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Account Balance</p>
                        <p class="card-value shimmer-text text-3xl font-bold text-slate-900" id="accountBalance">$0.00</p>
                        <p class="text-slate-500 text-sm font-medium mt-1">Available Cash</p>
                    </div>

                    <div class="card-icon w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="portfolio-card value-card bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Portfolio Value</p>
                        <p class="card-value shimmer-text text-3xl font-bold text-slate-900" id="totalValue">$0</p>
                        <p class="text-slate-500 text-sm font-medium mt-1">Invested Assets</p>
                    </div>
                    <div class="card-icon w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="portfolio-card change-card bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">24h Change</p>
                        <p class="card-value shimmer-text text-3xl font-bold text-emerald-600" id="change24h">+$0</p>
                        <p class="text-emerald-500 text-sm font-medium mt-1" id="changeRate24h">+0%</p>
                    </div>
                    <div class="card-icon w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="portfolio-card assets-card bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">Total Assets</p>
                        <p class="card-value shimmer-text text-3xl font-bold text-slate-900">0</p>
                        <p class="text-slate-500 text-sm font-medium mt-1">Holdings</p>
                    </div>
                    <div class="card-icon w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Portfolio Value Trend Chart -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-slate-900">Portfolio Performance</h3>
                    <div class="flex space-x-2">
                        <button class="portfolio-period-btn px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg font-medium" data-period="7">7D</button>
                        <button class="portfolio-period-btn px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg" data-period="30">30D</button>
                        <button class="portfolio-period-btn px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg" data-period="90">90D</button>
                        <button class="portfolio-period-btn px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg" data-period="365">1Y</button>
                    </div>
                </div>
                <div class="h-80 relative">
                    <canvas id="performanceChart"></canvas>
                    <!-- Loading state for portfolio chart -->
                    <div id="portfolioChartLoading" class="absolute inset-0 hidden items-center justify-center bg-white bg-opacity-90">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-slate-600 font-medium">Loading portfolio data...</span>
                        </div>
                    </div>
                    <!-- Empty state for portfolio chart -->
                    <div id="portfolioChartEmpty" class="absolute inset-0 hidden items-center justify-center">
                        <div class="text-center text-slate-500">
                            <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="text-sm font-medium">Select a user to view portfolio trend</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cumulative Return Calculator -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-slate-900">Cumulative Return</h3>
                    <!-- <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <span class="text-sm text-slate-600">Performance Analysis</span>
                    </div> -->
                </div>
                
                <!-- Date Range Selector -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-slate-700 mb-2">Start Date</label>
                            <input 
                                type="date" 
                                id="startDate" 
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                            >
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-slate-700 mb-2">End Date</label>
                            <input 
                                type="date" 
                                id="endDate" 
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                            >
                        </div>
                    </div>
                    <button 
                        id="calculateReturnBtn" 
                        class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                    >
                        Calculate Cumulative Return
                    </button>
                </div>
                
                <!-- Results Display -->
                <div class="space-y-4">
                    <!-- Loading State -->
                    <div id="returnCalculatorLoading" class="hidden items-center justify-center py-8">
                        <div class="flex items-center space-x-3">
                            <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-slate-600 font-medium">Calculating return...</span>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="returnResults" class="hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6">
                            <div class="text-center">
                                <div class="text-4xl font-bold mb-4" id="cumulativeReturn">0.00%</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">Start Asset Value</div>
                                    <div class="text-lg font-bold text-slate-900" id="startCost">$0.00</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">End Asset Value</div>
                                    <div class="text-lg font-bold text-slate-900" id="endPortfolioValue">$0.00</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-slate-500 mb-1">Absolute Gain/Loss</div>
                                    <div class="text-lg font-bold" id="absoluteGainLoss">$0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="returnCalculatorEmpty" class="flex items-center justify-center py-8">
                        <div class="text-center text-slate-500">
                            <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-sm font-medium">Select dates and calculate return</p>
                            <p class="text-xs text-slate-400 mt-1">Choose a user and date range to analyze performance</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Table -->
        <div class="bg-white shadow-xl rounded-2xl">
            <header class="px-6 py-4 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-slate-900">My Wallet</h2>
                    <button onclick="openAddAssetPage()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                        Add Asset
                    </button>
                </div>
            </header>
            <div class="p-6">

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="table-auto w-full">
                <!-- Table header -->
                <thead class="text-[13px] text-slate-500/70">
                    <tr>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">#</div>
                        </th>                                        
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">Name</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">Symbol</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">Quantity</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">Price</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">Market Value</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">24h</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left">7d</div>
                        </th>
                        <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r last:pl-5 last:sticky last:right-0">
                            <div class="font-medium text-left sr-only">Action</div>
                        </th>                                        
                    </tr>
                </thead>
                <!-- Table body -->
                <tbody class="text-sm font-medium">
                    <!-- Portfolio data will be populated here dynamically -->
                    <tr>
                        <td colspan="9" class="px-5 py-8 text-center text-slate-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <p class="text-lg font-medium">Select a user to view portfolio</p>
                                <p class="text-sm">Choose a user from the dropdown above</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
                    <!-- Row -->
                    <!-- <tr>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">1</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="flex items-center">
                                <svg class="shrink-0 mr-2 sm:mr-3" width="36" height="36" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="18" fill="#FFA037"/>
                                    <path fill="#fff" d="M24.563 16.236c.282-1.891-1.157-2.908-3.127-3.586l.64-2.562-1.56-.389-.622 2.495c-.41-.103-.831-.199-1.25-.294l.627-2.511L17.71 9l-.638 2.561c-.34-.077-.673-.153-.996-.234l.002-.008-2.15-.537-.416 1.666s1.157.265 1.133.281c.631.158.746.576.727.907l-.728 2.92c.044.01.1.026.162.051-.052-.013-.107-.027-.165-.04l-1.02 4.088c-.077.192-.273.48-.714.37.016.023-1.134-.282-1.134-.282L11 22.528l2.03.506c.377.095.747.194 1.112.287l-.646 2.591 1.558.389.639-2.564c.426.116.839.222 1.243.323l-.637 2.551 1.56.389.645-2.587c2.66.504 4.659.3 5.5-2.105.679-1.936-.033-3.053-1.432-3.782 1.019-.235 1.787-.905 1.991-2.29Zm-3.564 4.997c-.482 1.936-3.742.89-4.8.627l.857-3.433c1.057.264 4.447.786 3.943 2.806Zm.483-5.025c-.44 1.762-3.154.867-4.034.647l.776-3.113c.88.219 3.716.629 3.258 2.466Z"/>
                                </svg>
                                <div class="text-slate-900">Bitcoin</div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">BTC</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900 font-medium">0.5234</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">$67,177.77</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">19,672,925</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">0.7%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">1.34%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-red-500">-5.42%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-indigo-500 hover:text-white border border-slate-200 shadow-sm hover:bg-indigo-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-indigo-300 transition-colors group">
                                Sell <span class="text-slate-200 group-hover:text-indigo-400 transition-colors">/</span> Buy
                            </button>
                        </td>
                    </tr> -->
                    <!-- Row -->
                    <!-- <tr>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">2</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="flex items-center">
                                <svg class="shrink-0 mr-2 sm:mr-3" width="36" height="36" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="18" fill="#1E293B"/>
                                    <g clip-path="url(#a)">
                                        <path fill="url(#b)" d="M12.488 21.159a.5.5 0 0 1 .354-.146h12.22a.25.25 0 0 1 .176.427l-2.413 2.414a.5.5 0 0 1-.354.146H10.25a.25.25 0 0 1-.177-.427l2.414-2.414Z"/>
                                        <path fill="url(#c)" d="M12.488 12.146a.515.515 0 0 1 .354-.146h12.22a.25.25 0 0 1 .176.427l-2.413 2.414a.5.5 0 0 1-.354.147H10.25a.25.25 0 0 1-.177-.428l2.414-2.414Z"/>
                                        <path fill="url(#d)" d="M22.825 16.624a.5.5 0 0 0-.354-.146H10.25a.25.25 0 0 0-.177.427l2.414 2.414a.5.5 0 0 0 .354.146h12.22a.25.25 0 0 0 .176-.427l-2.413-2.414Z"/>
                                    </g>
                                    <defs>
                                        <linearGradient id="b" x1="23.894" x2="15.437" y1="10.558" y2="26.756" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#00FFA3"/>
                                        <stop offset="1" stop-color="#DC1FFF"/>
                                        </linearGradient>
                                        <linearGradient id="c" x1="20.196" x2="11.739" y1="8.627" y2="24.826" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#00FFA3"/>
                                        <stop offset="1" stop-color="#DC1FFF"/>
                                        </linearGradient>
                                        <linearGradient id="d" x1="22.033" x2="13.577" y1="9.587" y2="25.785" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#00FFA3"/>
                                        <stop offset="1" stop-color="#DC1FFF"/>
                                        </linearGradient>
                                        <clipPath id="a">
                                        <path fill="#fff" d="M10 12h15.311v12H10z"/>
                                        </clipPath>
                                    </defs>
                                </svg>
                                <div class="text-slate-900">Solana</div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">SOL</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900 font-medium">15.67</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">$187.50</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">444,812,093</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">0.24%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">1.77%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-red-500">-7.16%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-indigo-500 hover:text-white border border-slate-200 shadow-sm hover:bg-indigo-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-indigo-300 transition-colors group">
                                Sell <span class="text-slate-200 group-hover:text-indigo-400 transition-colors">/</span> Buy
                            </button>
                        </td>                                        
                    </tr> -->
                    <!-- Row -->
                    <!-- <tr>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">3</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="flex items-center">
                                <svg class="shrink-0 mr-2 sm:mr-3" width="36" height="36" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="18" fill="#E84191"/>
                                    <path fill="#fff" fill-rule="evenodd" d="M21.21 10.888c0 1.042-1.454 1.888-3.247 1.888-1.792 0-3.246-.846-3.246-1.888C14.717 9.845 16.171 9 17.963 9c1.793 0 3.246.845 3.246 1.888Zm0 14.224c0 1.043-1.454 1.888-3.247 1.888-1.792 0-3.246-.845-3.246-1.888 0-1.042 1.454-1.887 3.246-1.887 1.793 0 3.246.845 3.246 1.887Zm-7.77-9.723c.897-1.553.89-3.234-.013-3.756-.903-.521-2.362.314-3.258 1.867-.897 1.552-.891 3.233.012 3.755.904.522 2.363-.314 3.26-1.866Zm12.307 3.356c.902.521.908 2.202.012 3.755-.897 1.552-2.355 2.388-3.258 1.867-.903-.521-.909-2.203-.012-3.755.896-1.553 2.355-2.388 3.258-1.867Zm-12.32 5.622c.904-.522.91-2.203.013-3.756-.896-1.552-2.355-2.388-3.258-1.866-.904.522-.91 2.203-.014 3.755.897 1.553 2.356 2.389 3.26 1.867ZM25.76 13.5c.896 1.553.89 3.234-.012 3.755-.903.521-2.362-.314-3.258-1.867-.897-1.552-.891-3.233.012-3.755.903-.521 2.361.315 3.258 1.867Z" clip-rule="evenodd"/>
                                </svg>
                                <div class="text-slate-900">Polkadot</div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">DOT</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900 font-medium">234.89</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">$8.58</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">1,429,597,823</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">0.12%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">2.37%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-red-500">-2.22%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-indigo-500 hover:text-white border border-slate-200 shadow-sm hover:bg-indigo-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-indigo-300 transition-colors group">
                                Sell <span class="text-slate-200 group-hover:text-indigo-400 transition-colors">/</span> Buy
                            </button>
                        </td>                                        
                    </tr> -->
                    <!-- Row -->
                    <!-- <tr>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">4</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="flex items-center">
                                <svg class="shrink-0 mr-2 sm:mr-3" width="36" height="36" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="18" fill="#55BB86"/>
                                    <path fill="#fff" d="M24.563 16.236c.282-1.891-1.157-2.908-3.127-3.586l.64-2.562-1.56-.389-.622 2.495c-.41-.103-.831-.199-1.25-.294l.627-2.511L17.71 9l-.638 2.561c-.34-.077-.673-.153-.996-.234l.002-.008-2.15-.537-.416 1.666s1.157.265 1.133.281c.631.158.746.576.727.907l-.728 2.92c.044.01.1.026.162.051-.052-.013-.107-.027-.165-.04l-1.02 4.088c-.077.192-.273.48-.714.37.016.023-1.134-.282-1.134-.282L11 22.528l2.03.506c.377.095.747.194 1.112.287l-.646 2.591 1.558.389.639-2.564c.426.116.839.222 1.243.323l-.637 2.551 1.56.389.645-2.587c2.66.504 4.659.3 5.5-2.105.679-1.936-.033-3.053-1.432-3.782 1.019-.235 1.787-.905 1.991-2.29Zm-3.564 4.997c-.482 1.936-3.742.89-4.8.627l.857-3.433c1.057.264 4.447.786 3.943 2.806Zm.483-5.025c-.44 1.762-3.154.867-4.034.647l.776-3.113c.88.219 3.716.629 3.258 2.466Z"/>
                                </svg>
                                <div class="text-slate-900">Bitcoin Cash</div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">BCH</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900 font-medium">2.045</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">$642.47</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">19,687,569</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">3.40%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">1.22%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-red-500">-0.12%</div>
                        </td> 
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-indigo-500 hover:text-white border border-slate-200 shadow-sm hover:bg-indigo-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-indigo-300 transition-colors group">
                                Sell <span class="text-slate-200 group-hover:text-indigo-400 transition-colors">/</span> Buy
                            </button>
                        </td>                                    
                    </tr> -->
                    <!-- Row -->
                    <!-- <tr>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">5</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="flex items-center">
                                <svg class="shrink-0 mr-2 sm:mr-3" width="36" height="36" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="17.5" fill="#fff" stroke="#E2E8F0"/>
                                    <path fill="#0033AD" d="M12.932 17.927a1.458 1.458 0 0 0 1.374 1.535h.086a1.45 1.45 0 0 0 1.455-1.46 1.45 1.45 0 0 0-1.46-1.454c-.774 0-1.415.606-1.455 1.38ZM7.497 17.553a.471.471 0 1 0-.051.94.471.471 0 0 0 .05-.94ZM12.84 9.467a.476.476 0 0 0 .209-.635.476.476 0 0 0-.635-.208.47.47 0 0 0-.208.629.467.467 0 0 0 .635.214ZM14.318 12.047a.728.728 0 0 0 .323-.975.728.728 0 0 0-.975-.323.728.728 0 0 0-.324.975.728.728 0 0 0 .976.323ZM9.343 13.818a.604.604 0 0 0 .831-.173.604.604 0 0 0-.173-.831.604.604 0 0 0-.831.173.597.597 0 0 0 .173.831ZM10.23 17.293a.725.725 0 0 0-.768.687.725.725 0 0 0 .687.768.729.729 0 0 0 .08-1.454ZM9.424 22.18a.602.602 0 1 0 .544 1.075.602.602 0 0 0-.544-1.074ZM12.248 15.787a.85.85 0 0 0 1.183-.248.85.85 0 0 0-.248-1.184.85.85 0 0 0-1.183.249.852.852 0 0 0 .248 1.183ZM21.23 11.99c.334.218.79.126 1.01-.209a.732.732 0 0 0-.209-1.01.732.732 0 0 0-1.01.208.721.721 0 0 0 .208 1.01ZM22.72 9.421c.22.144.508.081.652-.138a.469.469 0 0 0-.139-.653.472.472 0 0 0-.652.133.486.486 0 0 0 .139.658ZM21.334 16.537A1.454 1.454 0 0 0 19.8 17.91a1.454 1.454 0 0 0 1.374 1.535h.08c.803 0 1.455-.652 1.455-1.46a1.446 1.446 0 0 0-1.373-1.448ZM14.798 15.683a1.457 1.457 0 1 0 2.603-1.316 1.455 1.455 0 0 0-1.957-.646 1.463 1.463 0 0 0-.646 1.962ZM26.22 13.819a.601.601 0 1 0-.814-.266.61.61 0 0 0 .814.266ZM22.527 14.28a.856.856 0 1 0 .768 1.53.856.856 0 0 0-.768-1.53ZM17.77 9.201a.608.608 0 0 0 .634-.565A.604.604 0 0 0 17.84 8a.603.603 0 0 0-.635.56.61.61 0 0 0 .566.64ZM17.754 12.97a.85.85 0 0 0 .9-.808.85.85 0 0 0-.807-.9.85.85 0 0 0-.9.807.854.854 0 0 0 .807.9ZM13.115 21.72a.856.856 0 1 0-.768-1.53.856.856 0 0 0 .768 1.53ZM18.308 14.222a1.453 1.453 0 0 0 .421 2.015 1.453 1.453 0 0 0 2.015-.422 1.453 1.453 0 0 0-1.218-2.25c-.49 0-.947.248-1.218.657ZM20.846 20.317a1.455 1.455 0 0 0-1.956-.646 1.455 1.455 0 0 0-.647 1.956 1.455 1.455 0 0 0 1.957.647 1.45 1.45 0 0 0 .652-1.945c0-.006 0-.006-.006-.012ZM23.394 20.213a.85.85 0 0 0-1.183.248.85.85 0 0 0 .248 1.183.85.85 0 0 0 1.183-.248.852.852 0 0 0-.248-1.183ZM26.182 18.026a.725.725 0 0 0-.687-.768.725.725 0 0 0-.767.687.725.725 0 0 0 .687.767.733.733 0 0 0 .767-.686ZM28.2 17.506a.471.471 0 1 0 .444.496.475.475 0 0 0-.444-.496ZM26.295 22.182a.604.604 0 0 0-.83.173.603.603 0 0 0 .172.831.604.604 0 0 0 .831-.173.597.597 0 0 0-.173-.831ZM12.925 26.58a.472.472 0 0 0-.652.133.472.472 0 0 0 .133.652c.22.144.508.08.652-.133a.463.463 0 0 0-.133-.652ZM22.804 26.534a.476.476 0 0 0-.207.634c.115.231.404.324.634.208a.47.47 0 0 0 .208-.629.467.467 0 0 0-.635-.213ZM17.33 21.777a1.461 1.461 0 0 0-.421-2.02 1.461 1.461 0 0 0-2.02.421 1.456 1.456 0 0 0 1.217 2.257c.497.006.953-.242 1.224-.658ZM14.418 24.012a.732.732 0 0 0-1.01.207.732.732 0 0 0 .208 1.01c.335.22.79.127 1.01-.207a.722.722 0 0 0-.208-1.01ZM17.816 26.799a.608.608 0 0 0-.635.565.604.604 0 0 0 .566.635.604.604 0 0 0 .635-.56.61.61 0 0 0-.566-.64ZM17.824 23.03a.85.85 0 0 0-.9.808.85.85 0 0 0 .808.9.854.854 0 0 0 .9-.808.853.853 0 0 0-.808-.9ZM21.32 23.953a.73.73 0 0 0 .664 1.299.728.728 0 1 0-.664-1.299Z"/>
                                </svg>
                                <div class="text-slate-900">Cardano</div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-500">ADA</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900 font-medium">1,247.33</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">$0.59</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-slate-900">35,597,278,129</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">0.67%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-emerald-500">3.32%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <div class="text-red-500">-0.32%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 last:border-none first:pl-3 last:pr-3 last:bg-gradient-to-r last:from-transparent last:to-white last:to-[12px] last:pl-5 last:sticky last:right-0">
                            <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-indigo-500 hover:text-white border border-slate-200 shadow-sm hover:bg-indigo-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-indigo-300 transition-colors group">
                                Sell <span class="text-slate-200 group-hover:text-indigo-400 transition-colors">/</span> Buy
                            </button>
                        </td>                                        
                    </tr> -->
                </tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Transaction History Table -->
        <div class="bg-white shadow-xl rounded-2xl mt-8">
            <header class="px-6 py-4 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-slate-900">Transaction History</h2>
                    <div class="flex items-center space-x-3">
                        <!-- Export Dropdown -->
                        <div class="relative">
                            <button 
                                id="exportDropdownBtn" 
                                class="flex items-center space-x-2 px-3 py-2 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors"
                                onclick="toggleExportDropdown()"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span>Export</span>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <!-- Dropdown Menu -->
                            <div 
                                id="exportDropdownMenu" 
                                class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 z-50 hidden"
                            >
                                <div class="py-1">
                                    <button 
                                        onclick="exportTransactions('csv')" 
                                        class="flex items-center space-x-3 w-full px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                                    >
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span>Export as CSV</span>
                                    </button>
                                    <button 
                                        onclick="exportTransactions('excel')" 
                                        class="flex items-center space-x-3 w-full px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition-colors"
                                    >
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span>Export as Excel</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="p-6">
                <!-- Transaction Table -->
                <div class="overflow-x-auto">
                    <table class="table-auto w-full" id="transactionsTable">
                        <!-- Table header -->
                        <thead class="text-[13px] text-slate-500/70">
                            <tr>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-left">Date</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-left">Type</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-left">Stock</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-left">Company</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-right">Quantity</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-right">Price</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-right">Total Value</div>
                                </th>
                                <th class="px-5 py-2 first:pl-3 last:pr-3 bg-slate-100 first:rounded-l last:rounded-r">
                                    <div class="font-medium text-left">Sector</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Transaction rows will be populated dynamically -->
                            <tr>
                                <td colspan="8" class="px-5 py-8 text-center text-slate-500">
                                    <div class="flex items-center justify-center space-x-2">
                                        <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                        <span>Loading transactions...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="flex items-center justify-between mt-4 px-2" id="transactionsPagination" style="display: none;">
                    <div class="text-sm text-slate-600">
                        Showing <span id="transactionsShowingStart">1</span> to <span id="transactionsShowingEnd">5</span> of <span id="transactionsTotalCount">0</span> transactions
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="transactionsPrevBtn" onclick="changeTransactionsPage(-1)" 
                                class="px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Previous
                        </button>
                        <span class="text-sm text-slate-600">
                            Page <span id="transactionsCurrentPage">1</span> of <span id="transactionsTotalPages">1</span>
                        </span>
                        <button id="transactionsNextBtn" onclick="changeTransactionsPage(1)" 
                                class="px-3 py-1 text-sm bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sector Allocation Pie Chart -->
        <div class="bg-white shadow-xl rounded-2xl mt-8">
            <header class="px-6 py-4 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-slate-900">Sector Allocation</h2>
                    <!-- <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <span class="text-sm text-slate-600">Portfolio Distribution</span>
                    </div> -->
                </div>
            </header>
            <div class="p-6">
                <div class="h-80 flex items-center justify-center">
                    <canvas id="sectorChart"></canvas>
                </div>
                <div class="mt-4 space-y-2" id="sectorLegend">
                    <!-- Sector legend will be populated dynamically -->
                </div>
            </div>
        </div>

    </div>
    <script>
        // Global variables
        let currentUserId = null;
        let currentUser = null;
        
        // Transaction pagination variables
        let allTransactions = [];
        let currentTransactionPage = 1;
        const transactionsPerPage = 5;
        const API_BASE = 'http://localhost:5000';

        // User Management Functions
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const data = await response.json();
                
                if (data.users) {
                    populateUsersDropdown(data.users);
                } else {
                    console.error('No users data received');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showUserError('Failed to load users');
            }
        }

        function populateUsersDropdown(users) {
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="p-4 text-center text-slate-500">
                        <span class="text-sm">No users found</span>
                    </div>
                `;
                return;
            }

            const usersHTML = users.map(user => `
                <div class="user-item p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0" 
                     onclick="selectUser('${user.id}', '${user.username}', '${user.name}', '${user.email}', '${user.account_id}')">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">
                                ${(user.name || user.username || 'U').charAt(0).toUpperCase()}
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-slate-900">
                                ${user.name}
                            </div>
                            <div class="text-xs text-slate-500 truncate">${user.email}</div>
                            <div class="text-xs text-slate-400">ID: ${user.id}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            usersList.innerHTML = usersHTML;
            
            // Try to restore previously selected user from localStorage
            const savedUserId = localStorage.getItem('selectedUserId');
            let userToSelect = null;
            
            if (savedUserId) {
                // Try to find the previously selected user
                userToSelect = users.find(user => user.id == savedUserId);
            }
            
            // If no saved user or saved user not found, fall back to user with ID = 1
            if (!userToSelect) {
                userToSelect = users.find(user => user.id == 1);
            }
            
            // Select the determined user
            if (userToSelect) {
                selectUser(userToSelect.id, userToSelect.username, userToSelect.name, userToSelect.email, userToSelect.account_id);
            }
        }

        function selectUser(id, username, name, email, account_id){
            currentUserId = id;
            currentUser = {
                user_id: id,
                username: username,
                email: email,
                name: name,
                account_id: account_id
            };

            // Save selected user ID to localStorage for persistence across page refreshes
            localStorage.setItem('selectedUserId', id);

            // Update UI
            const displayName = name;
            document.getElementById('selectedUserName').textContent = displayName;
            document.getElementById('selectedUserEmail').textContent = email;

            // Close dropdown
            document.getElementById('userDropdownMenu').classList.add('hidden');

            // Reset cumulative return calculator to empty state
            resetCumulativeReturnCalculator();
            
            // Reset 24h change block to default values
            reset24hChangeBlock();
            
            // Reset portfolio summary cards
            resetPortfolioSummary();

            // Load user's portfolio data
            loadUserPortfolio(id);
            
            console.log('Selected user:', currentUser);
        }

        function clearSavedUser() {
            // Clear saved user from localStorage (useful for cleanup)
            localStorage.removeItem('selectedUserId');
        }

       async function loadUserPortfolio(user_id) {
            try {
                showPortfolioLoading(true);

                const walletResponse = await fetch(`${API_BASE}/wallet?user_id=${user_id}`);
                const walletData = await walletResponse.json();

                if (walletData.wallet) {
                document.getElementById('totalValue').textContent = 
                    `$${walletData.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const totalAssetsElement = document.querySelector('.grid .bg-white:nth-child(4) .text-3xl');
                if (totalAssetsElement) totalAssetsElement.textContent = walletData.count || 0;

                populateWalletTable(walletData.wallet);
                updatePortfolioSummary(walletData.wallet, walletData.totalValue);
                
                // Update sector allocation chart
                const sectorData = calculateSectorAllocations(walletData.wallet, walletData.totalValue);
                updateSectorChart(sectorData);
                
                // Load portfolio trend chart
                loadPortfolioTrend(user_id, currentPortfolioPeriod);
                
                // Load transaction history
                loadUserTransactions(user_id);
                } else {
                console.error('No wallet data received');
                
                // Set total assets to 0 when no wallet data
                const totalAssetsElement = document.querySelector('.grid .bg-white:nth-child(4) .text-3xl');
                if (totalAssetsElement) totalAssetsElement.textContent = '0';
                
                // Set total value to $0.00 when no wallet data
                document.getElementById('totalValue').textContent = '$0.00';
                
                // Reset 24h change to $0.00 (0.00%) when no wallet data
                document.getElementById('change24h').textContent = '$0.00';
                document.getElementById('change24h').className = 'text-3xl font-bold text-slate-400';
                document.getElementById('changeRate24h').textContent = '0.00%';
                document.getElementById('changeRate24h').className = 'text-slate-400 text-sm font-medium mt-1';
                
                populateWalletTable([]);
                updateSectorChart([]); // Show empty state
                showPortfolioChartState('empty'); // Show empty portfolio chart
                
                // Load transaction history even if no wallet data
                loadUserTransactions(user_id);
                }

                const balanceResponse = await fetch(`${API_BASE}/balance?user_id=${user_id}`);
                const balanceData = await balanceResponse.json();
                if (balanceData.balance !== undefined) {
                console.log('User cash balance:', balanceData.balance);
                document.getElementById('accountBalance').textContent = 
                    `$${parseFloat(balanceData.balance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

            } catch (error) {
                console.error('Error loading user portfolio:', error);
                showPortfolioError('Failed to load portfolio data');
            } finally {
                showPortfolioLoading(false);
            }
            }
        // Load portfolio data without transaction history (for periodic refreshes)
        async function loadUserPortfolioOnly(user_id) {
            try {
                showPortfolioLoading(true);

                const walletResponse = await fetch(`${API_BASE}/wallet?user_id=${user_id}`);
                const walletData = await walletResponse.json();

                if (walletData.wallet) {
                document.getElementById('totalValue').textContent = 
                    `$${walletData.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const totalAssetsElement = document.querySelector('.grid .bg-white:nth-child(4) .text-3xl');
                if (totalAssetsElement) totalAssetsElement.textContent = walletData.count || 0;

                populateWalletTable(walletData.wallet);
                updatePortfolioSummary(walletData.wallet, walletData.totalValue);
                
                // Update sector allocation chart
                const sectorData = calculateSectorAllocations(walletData.wallet, walletData.totalValue);
                updateSectorChart(sectorData);
                
                // Load portfolio trend chart
                loadPortfolioTrend(user_id, currentPortfolioPeriod);
                
                // NOTE: Transaction history is NOT loaded here (only on user change)
                } else {
                console.error('No wallet data received');
                
                // Set total assets to 0 when no wallet data
                const totalAssetsElement = document.querySelector('.grid .bg-white:nth-child(4) .text-3xl');
                if (totalAssetsElement) totalAssetsElement.textContent = '0';
                
                // Set total value to $0.00 when no wallet data
                document.getElementById('totalValue').textContent = '$0.00';
                
                // Reset 24h change to $0.00 (0.00%) when no wallet data
                document.getElementById('change24h').textContent = '$0.00';
                document.getElementById('change24h').className = 'text-3xl font-bold text-slate-400';
                document.getElementById('changeRate24h').textContent = '0.00%';
                document.getElementById('changeRate24h').className = 'text-slate-400 text-sm font-medium mt-1';
                
                populateWalletTable([]);
                updateSectorChart([]); // Show empty state
                showPortfolioChartState('empty'); // Show empty portfolio chart
                
                // NOTE: Transaction history is NOT loaded here (only on user change)
                }

                const balanceResponse = await fetch(`${API_BASE}/balance?user_id=${user_id}`);
                const balanceData = await balanceResponse.json();
                if (balanceData.balance !== undefined) {
                console.log('User cash balance:', balanceData.balance);
                document.getElementById('accountBalance').textContent = 
                    `$${parseFloat(balanceData.balance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

            } catch (error) {
                console.error('Error loading user portfolio:', error);
                showPortfolioError('Failed to load portfolio data');
            } finally {
                showPortfolioLoading(false);
            }
        }
        function renderStockLogo(stock) {
            if (stock.logo) {
                return `<img src="${stock.logo}" class="stock-logo" onerror="this.style.display='none';">`;
            } else {
                return ``;
            }
        }

        function populateWalletTable(walletData) {
            const tableBody = document.querySelector('tbody');
            
            if (!walletData || walletData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-5 py-8 text-center text-slate-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8l-2-2m0 0l-2 2m2-2v6m-6 6l2 2m0 0l2-2m-2 2V9"></path>
                                </svg>
                                <p class="text-lg font-medium">No stocks in portfolio</p>
                                <p class="text-sm">Start trading to build your portfolio</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const tableHTML = walletData.map((stock, index) => {
                const gainLossClass = stock.gainLoss >= 0 ? 'text-emerald-600' : 'text-red-600';
                const change24hClass = stock.change24h >= 0 ? 'text-emerald-600' : 'text-red-600';
                const change7dClass = stock.change7d >= 0 ? 'text-emerald-600' : 'text-red-600';
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium text-slate-900">${index + 1}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="flex items-center space-x-3">
                                ${stock.logo ? `
                                    <div class="stock-logo-container spin-in">
                                        ${renderStockLogo(stock)}
                                    </div>
                                ` : ''}
                                <div>
                                    <div class="font-medium text-slate-900">${stock.name}</div>
                                    <div class="text-xs text-slate-500">${stock.sector}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium text-slate-900">${stock.symbol}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium text-slate-900">${stock.quantity.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium text-slate-900">$${stock.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium text-slate-900">$${stock.marketValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium ${change24hClass}">${stock.change24h >= 0 ? '+' : ''}${stock.change24h.toFixed(2)}%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="font-medium ${change7dClass}">${stock.change7d >= 0 ? '+' : ''}${stock.change7d.toFixed(2)}%</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="flex space-x-2">
                                <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-red-500 hover:text-white border border-red-200 shadow-sm hover:bg-red-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-red-300 transition-colors"
                                        onclick="openTradeModal('${stock.symbol}', '${stock.name}', 'sell')">
                                    Sell
                                </button>
                                <button class="h-8 whitespace-nowrap justify-center rounded-full px-3 py-1 text-sm font-medium text-green-500 hover:text-white border border-green-200 shadow-sm hover:bg-green-600 focus-visible:outline-none focus-visible:ring focus-visible:ring-green-300 transition-colors"
                                        onclick="openTradeModal('${stock.symbol}', '${stock.name}', 'buy')">
                                    Buy
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = tableHTML;
            
            // Trigger logo animations with staggered delays
            setTimeout(() => {
                const logoContainers = document.querySelectorAll('.stock-logo-container.spin-in');
                logoContainers.forEach((container, index) => {
                    setTimeout(() => {
                        container.style.animationDelay = `${index * 0.1}s`;
                    }, index * 50);
                });
                
                // Remove spin-in class after animation completes to allow hover animations
                setTimeout(() => {
                    logoContainers.forEach(container => {
                        container.classList.remove('spin-in');
                    });
                }, 1500); // After all animations complete
            }, 100);
        }

        function updatePortfolioSummary(walletData, totalValue) {
            if (!walletData || walletData.length === 0) return;
            
            // Calculate total 24h change
            let totalChange24h = 0;
            let totalPreviousValue = 0;
            
            walletData.forEach(stock => {
                const previousPrice = stock.currentPrice / (1 + stock.change24h / 100);
                const previousValue = stock.quantity * previousPrice;
                totalPreviousValue += previousValue;
            });
            
            totalChange24h = totalValue - totalPreviousValue;
            const changePercent = totalPreviousValue > 0 ? (totalChange24h / totalPreviousValue * 100) : 0;
            
            // Update 24h change card
            const changeValueElement = document.getElementById('change24h');
            const changePercentElement = document.getElementById('changeRate24h');
            
            if (changeValueElement) {
                const changeClass = totalChange24h >= 0 ? 'text-emerald-600' : 'text-red-600';
                changeValueElement.className = `text-3xl font-bold ${changeClass}`;
                changeValueElement.textContent = `${totalChange24h >= 0 ? '+' : ''}$${Math.abs(totalChange24h).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            if (changePercentElement) {
                const changeClass = changePercent >= 0 ? 'text-emerald-500' : 'text-red-500';
                changePercentElement.className = `${changeClass} text-sm font-medium mt-1`;
                changePercentElement.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            }
        }

        function showPortfolioLoading(show) {
            const tableBody = document.querySelector('tbody');
            if (show) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-5 py-8 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                <span class="text-slate-600">Loading portfolio...</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function showPortfolioError(message) {
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-5 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-red-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-lg font-medium">${message}</p>
                            <button onclick="loadUserPortfolio(currentUserId)" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                Retry
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function openTradeModal(symbol, name, action) {
            // Redirect to homebroker with selected stock, action, and current user
            let url = `homebroker.html?symbol=${symbol}&name=${encodeURIComponent(name)}&action=${action}`;
            
            // Add current user ID if available
            if (currentUserId) {
                url += `&user_id=${currentUserId}`;
            }
            
            window.location.href = url;
        }

        function openAddAssetPage() {
            // Redirect to homebroker with current user for adding new assets
            let url = `homebroker.html`;
            
            // Add current user ID if available
            if (currentUserId) {
                url += `?user_id=${currentUserId}`;
            }
            
            window.location.href = url;
        }

        function openHomeBrokerPage() {
            // Redirect to homebroker with current user
            let url = `homebroker.html`;
            
            // Add current user ID if available
            if (currentUserId) {
                url += `?user_id=${currentUserId}`;
            }
            
            window.location.href = url;
        }

        function showUserError(message) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = `
                <div class="p-4 text-center text-red-500">
                    <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm">${message}</span>
                </div>
            `;
        }

        // Transaction History Functions
        async function loadUserTransactions(user_id) {
            try {
                showTransactionsLoading(true);
                
                const response = await fetch(`${API_BASE}/transactions?user_id=${user_id}`);
                const transactions = await response.json();
                
                if (Array.isArray(transactions)) {
                    allTransactions = transactions;
                    currentTransactionPage = 1; // Reset to first page
                    displayTransactionsPage();
                } else {
                    console.error('Invalid transactions data received:', transactions);
                    showTransactionsError('Failed to load transaction data');
                }
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                showTransactionsError('Failed to load transactions');
            }
        }

        function displayTransactionsPage() {
            const tableBody = document.getElementById('transactionsTableBody');
            const paginationDiv = document.getElementById('transactionsPagination');
            
            if (!allTransactions || allTransactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-5 py-8 text-center text-slate-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <p class="text-lg font-medium">No transactions found</p>
                                <p class="text-sm text-slate-400 mt-1">Start trading to see your transaction history</p>
                            </div>
                        </td>
                    </tr>
                `;
                paginationDiv.style.display = 'none';
                return;
            }

            // Calculate pagination
            const totalTransactions = allTransactions.length;
            const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
            const startIndex = (currentTransactionPage - 1) * transactionsPerPage;
            const endIndex = Math.min(startIndex + transactionsPerPage, totalTransactions);
            const pageTransactions = allTransactions.slice(startIndex, endIndex);

            // Generate table HTML for current page
            const tableHTML = pageTransactions.map(transaction => {
                const date = new Date(transaction.transaction_date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const formattedTime = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const quantity = parseFloat(transaction.quantity);
                const price = parseFloat(transaction.price);
                const totalValue = quantity * price;
                
                const typeClass = transaction.transaction_type.toLowerCase() === 'buy' 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="text-sm font-medium text-slate-900">${formattedDate}</div>
                            <div class="text-xs text-slate-500">${formattedTime}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeClass}">
                                ${transaction.transaction_type.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="text-sm font-medium text-slate-900">${transaction.symbol}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="text-sm text-slate-900">${transaction.company_name || transaction.symbol}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 text-right">
                            <div class="text-sm font-medium text-slate-900">${quantity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 text-right">
                            <div class="text-sm font-medium text-slate-900">$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200 text-right">
                            <div class="text-sm font-medium text-slate-900">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </td>
                        <td class="px-5 py-3 border-b border-slate-200">
                            <div class="text-sm text-slate-600">${transaction.sector || 'Unknown'}</div>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = tableHTML;

            // Update pagination info
            updateTransactionsPagination(startIndex + 1, endIndex, totalTransactions, currentTransactionPage, totalPages);
            
            // Show pagination if there are multiple pages
            paginationDiv.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        function updateTransactionsPagination(showingStart, showingEnd, totalCount, currentPage, totalPages) {
            document.getElementById('transactionsShowingStart').textContent = showingStart;
            document.getElementById('transactionsShowingEnd').textContent = showingEnd;
            document.getElementById('transactionsTotalCount').textContent = totalCount;
            document.getElementById('transactionsCurrentPage').textContent = currentPage;
            document.getElementById('transactionsTotalPages').textContent = totalPages;
            
            // Update button states
            const prevBtn = document.getElementById('transactionsPrevBtn');
            const nextBtn = document.getElementById('transactionsNextBtn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        function changeTransactionsPage(direction) {
            const totalPages = Math.ceil(allTransactions.length / transactionsPerPage);
            const newPage = currentTransactionPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentTransactionPage = newPage;
                displayTransactionsPage();
            }
        }

        function showTransactionsLoading(show) {
            const tableBody = document.getElementById('transactionsTableBody');
            if (show) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-5 py-8 text-center text-slate-500">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                <span>Loading transactions...</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function showTransactionsError(message) {
            const tableBody = document.getElementById('transactionsTableBody');
            const paginationDiv = document.getElementById('transactionsPagination');
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-5 py-8 text-center text-red-500">
                        <div class="flex flex-col items-center">
                            <svg class="w-12 h-12 text-red-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-lg font-medium">${message}</p>
                            <button onclick="loadUserTransactions(currentUserId)" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                Retry
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            // Hide pagination on error
            paginationDiv.style.display = 'none';
        }

        // Export Functions
        function toggleExportDropdown() {
            const dropdown = document.getElementById('exportDropdownMenu');
            dropdown.classList.toggle('hidden');
            
            // Close dropdown when clicking outside
            if (!dropdown.classList.contains('hidden')) {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!e.target.closest('#exportDropdownBtn') && !e.target.closest('#exportDropdownMenu')) {
                        dropdown.classList.add('hidden');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }
        }

        function exportTransactions(format) {
            // Close the dropdown
            document.getElementById('exportDropdownMenu').classList.add('hidden');
            
            // Check if user is selected and has transactions
            if (!currentUserId) {
                showNotification('Please select a user first', 'error');
                return;
            }
            
            if (!allTransactions || allTransactions.length === 0) {
                showNotification('No transactions to export', 'warning');
                return;
            }
            
            // Show loading notification
            showNotification('Preparing export...', 'info');
            
            try {
                if (format === 'csv') {
                    exportToCSV();
                } else if (format === 'excel') {
                    exportToExcel();
                }
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed. Please try again.', 'error');
            }
        }

        function exportToCSV() {
            // Prepare CSV headers
            const headers = [
                'Transaction Number',
                'Symbol',
                'Type',
                'Quantity',
                'Price per Share',
                'Total Value',
                'Date',
                'Time'
            ];
            
            // Prepare CSV data
            const csvData = allTransactions.map(transaction => {
                const date = new Date(transaction.transaction_date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const formattedTime = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const quantity = parseFloat(transaction.quantity) || 0;
                const price = parseFloat(transaction.price) || 0;
                const totalValue = quantity * price;
                
                return [
                    transaction.transaction_id || '',
                    transaction.symbol || '',
                    transaction.transaction_type || '',
                    quantity,
                    price.toFixed(2),
                    totalValue.toFixed(2),
                    formattedDate,
                    formattedTime
                ];
            });
            
            // Convert to CSV string
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const userName = currentUser?.name || currentUser?.username || 'user';
            const now = new Date();
            const dateStamp = now.toISOString().split('T')[0];
            const timeStamp = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const fileName = `${userName}_transactions_${dateStamp}_${timeStamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`CSV exported successfully: ${fileName}`, 'success');
        }

        function exportToExcel() {
            // For Excel export, we'll create an HTML table and save as .xls
            // This provides basic Excel compatibility without external libraries
            
            const headers = [
                'Transaction Number',
                'Symbol',
                'Type',
                'Quantity',
                'Price per Share',
                'Total Value',
                'Date',
                'Time'
            ];
            
            // Create HTML table for Excel
            let excelContent = `
                <table border="1">
                    <thead>
                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                            ${headers.map(header => `<th style="padding: 8px;">${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allTransactions.forEach(transaction => {
                const date = new Date(transaction.transaction_date);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const formattedTime = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const quantity = parseFloat(transaction.quantity) || 0;
                const price = parseFloat(transaction.price) || 0;
                const totalValue = quantity * price;
                
                const typeColor = transaction.transaction_type?.toUpperCase() === 'BUY' ? '#10b981' : '#ef4444';
                
                excelContent += `
                    <tr>
                        <td style="padding: 6px;">${transaction.transaction_id || ''}</td>
                        <td style="padding: 6px; font-weight: bold;">${transaction.symbol || ''}</td>
                        <td style="padding: 6px; color: ${typeColor}; font-weight: bold;">${transaction.transaction_type?.toUpperCase() || ''}</td>
                        <td style="padding: 6px; text-align: right;">${quantity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</td>
                        <td style="padding: 6px; text-align: right;">$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td style="padding: 6px; text-align: right; font-weight: bold;">$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td style="padding: 6px;">${formattedDate}</td>
                        <td style="padding: 6px;">${formattedTime}</td>
                    </tr>
                `;
            });
            
            excelContent += `
                    </tbody>
                </table>
            `;
            
            // Create and download file
            const blob = new Blob([excelContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const userName = currentUser?.name || currentUser?.username || 'user';
            const now = new Date();
            const dateStamp = now.toISOString().split('T')[0];
            const timeStamp = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            const fileName = `${userName}_transactions_${dateStamp}_${timeStamp}.xls`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Excel file exported successfully: ${fileName}`, 'success');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // Set colors based on type
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        // Sector Allocation Functions
        function calculateSectorAllocations(walletData, totalValue) {
            const sectorMap = new Map();
            
            walletData.forEach(stock => {
                const sector = stock.sector || 'Unknown';
                const marketValue = stock.quantity * stock.currentPrice;
                console.log(stock.quantity, stock.currentPrice, marketValue);
                
                if (sectorMap.has(sector)) {
                    sectorMap.set(sector, sectorMap.get(sector) + marketValue);
                } else {
                    sectorMap.set(sector, marketValue);
                }
            });

            console.log(totalValue);
            console.log(sectorMap);
            
            // Convert to array and calculate percentages
            const sectorData = Array.from(sectorMap.entries()).map(([sector, value]) => ({
                sector,
                value,
                percentage: (value / totalValue) * 100
            }));
            
            // Sort by value descending
            sectorData.sort((a, b) => b.value - a.value);
            
            return sectorData;
        }

        function updateSectorChart(sectorData) {
            // Destroy existing chart if it exists
            if (sectorChart) {
                sectorChart.destroy();
            }
            
            if (!sectorData || sectorData.length === 0) {
                // Show empty state
                const sectorLegend = document.getElementById('sectorLegend');
                sectorLegend.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <p class="text-sm">No sector data available</p>
                    </div>
                `;
                return;
            }
            
            // Color palette for sectors
            const colors = [
                '#3b82f6', // Blue
                '#10b981', // Green
                '#f59e0b', // Yellow
                '#ef4444', // Red
                '#8b5cf6', // Purple
                '#ec4899', // Pink
                '#f97316', // Orange
                '#06b6d4', // Cyan
                '#84cc16', // Lime
                '#6366f1'  // Indigo
            ];
            
            const labels = sectorData.map(item => item.sector);
            const data = sectorData.map(item => item.percentage);
            const backgroundColors = sectorData.map((_, index) => colors[index % colors.length]);
            
            // Create new chart
            sectorChart = new Chart(sectorCtx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#374151',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const sectorName = context.label;
                                    const percentage = context.parsed.toFixed(1) + '%';
                                    const sectorValue = sectorData[context.dataIndex].value;
                                    const formattedValue = '$' + sectorValue.toLocaleString('en-US', { 
                                        minimumFractionDigits: 2, 
                                        maximumFractionDigits: 2 
                                    });
                                    return [
                                        'Percentage: ' + percentage,
                                        'Value: ' + formattedValue
                                    ];
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                }
            });
            
            // Update legend
            updateSectorLegend(sectorData, backgroundColors);
        }

        function updateSectorLegend(sectorData, colors) {
            const sectorLegend = document.getElementById('sectorLegend');
            
            const legendHTML = sectorData.map((item, index) => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${colors[index]}"></div>
                        <span class="text-sm font-medium text-slate-700">${item.sector}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-slate-900">${item.percentage.toFixed(1)}%</div>
                        <div class="text-xs text-slate-500">$${item.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    </div>
                </div>
            `).join('');
            
            sectorLegend.innerHTML = legendHTML;
        }



        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load users on page load
            loadUsers();

            // User dropdown toggle
            const userDropdownBtn = document.getElementById('userDropdownBtn');
            const userDropdownMenu = document.getElementById('userDropdownMenu');

            userDropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdownMenu.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!userDropdownBtn.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                    userDropdownMenu.classList.add('hidden');
                }
            });

            // Prevent dropdown from closing when clicking inside
            userDropdownMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });



            // Portfolio Period Button Event Listeners
            const portfolioPeriodBtns = document.querySelectorAll('.portfolio-period-btn');
            
            portfolioPeriodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active state
                    portfolioPeriodBtns.forEach(b => {
                        b.classList.remove('bg-indigo-100', 'text-indigo-700');
                        b.classList.add('text-slate-500', 'hover:bg-slate-100');
                    });
                    
                    this.classList.add('bg-indigo-100', 'text-indigo-700');
                    this.classList.remove('text-slate-500', 'hover:bg-slate-100');
                    
                    currentPortfolioPeriod = parseInt(this.dataset.period);
                    
                    // Reload portfolio trend if a user is selected
                    if (currentUserId) {
                        loadPortfolioTrend(currentUserId, currentPortfolioPeriod);
                    }
                });
            });

            // Initialize portfolio chart with empty state
            showPortfolioChartState('empty');
            
            // Initialize cumulative return calculator with empty state
            showReturnCalculatorState('empty');
            
            // Auto-refresh portfolio data every 60 seconds (excluding transaction history)
            setInterval(function() {
                if (currentUserId) {
                    console.log('Auto-refreshing portfolio data...');
                    loadUserPortfolioOnly(currentUserId); // Load portfolio data without transactions
                }
            }, 60000); // 60 seconds
        });

        // Portfolio Value Trend Chart
        let portfolioTrendChart = null;
        let currentPortfolioPeriod = 7;
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');

        async function loadPortfolioTrend(userId, days = 7) {
            if (!userId) {
                showPortfolioChartState('empty');
                return;
            }

            try {
                showPortfolioChartState('loading');
                
                // Fetch portfolio value, cost data, and historical balance data
                const [valueResponse, costResponse, balanceResponse] = await Promise.all([
                    fetch(`${API_BASE}/historical-data?user_id=${userId}`),
                    fetch(`${API_BASE}/historical-cost?user_id=${userId}`),
                    fetch(`${API_BASE}/historical-balance?user_id=${userId}`)
                ]);
                
                const valueData = await valueResponse.json();
                const costData = await costResponse.json();
                const balanceData = await balanceResponse.json();
                
                if (valueData.error) {
                    throw new Error(valueData.error);
                }
                
                if (costData.error) {
                    throw new Error(costData.error);
                }
                
                if (balanceData.error) {
                    throw new Error(balanceData.error);
                }
                
                updatePortfolioTrendChart(valueData, costData, balanceData);
                showPortfolioChartState('chart');
                
            } catch (error) {
                console.error('Error loading portfolio trend:', error);
                showPortfolioChartState('empty');
            }
        }

        function updatePortfolioTrendChart(valueData, costData, balanceData) {
            // Destroy existing chart if it exists
            if (portfolioTrendChart) {
                portfolioTrendChart.destroy();
            }

            // Sort data by date to ensure chronological order
            const sortedValueData = valueData.sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedCostData = costData.sort((a, b) => new Date(a.date) - new Date(b.date));
            const sortedBalanceData = balanceData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Filter data to show only the requested number of days (latest days)
            const filteredValueData = sortedValueData.slice(-currentPortfolioPeriod);
            const filteredCostData = sortedCostData.slice(-currentPortfolioPeriod);
            const filteredBalanceData = sortedBalanceData.slice(-currentPortfolioPeriod);

            // Prepare data for Chart.js
            const labels = filteredValueData.map(item => {
                const date = new Date(item.date);
                if (currentPortfolioPeriod <= 7) {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (currentPortfolioPeriod <= 90) {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                }
            });
            
            // Get current account balance and portfolio value from the displayed values for today's exact value
            const accountBalanceText = document.getElementById('accountBalance').textContent;
            const portfolioValueText = document.getElementById('totalValue').textContent;
            
            // Parse the displayed values (remove $ and commas)
            const currentAccountBalance = parseFloat(accountBalanceText.replace(/[$,]/g, '')) || 0;
            const currentPortfolioValue = parseFloat(portfolioValueText.replace(/[$,]/g, '')) || 0;
            
            // Extract historical data values
            const portfolioValues = filteredValueData.map(item => parseFloat(item.value));
            const costs = filteredCostData.map(item => parseFloat(item.value));
            const balances = filteredBalanceData.map(item => parseFloat(item.value));
            
            // Create a map of dates to balance values for proper matching
            const balanceMap = new Map();
            filteredBalanceData.forEach(item => {
                balanceMap.set(item.date, parseFloat(item.balance));
            });
            
            
            // Calculate total values (portfolio value + account balance) for each day
            const totalValues = filteredValueData.map((item, index) => {
                const portfolioValue = parseFloat(item.value);
                const balance = balanceMap.get(item.date) || 0; // Get balance for the same date
                return portfolioValue + balance;
            });
            
            // For today's value (last entry), use the exact displayed values to ensure accuracy
            if (totalValues.length > 0) {
                totalValues[totalValues.length - 1] = currentAccountBalance + currentPortfolioValue;
            }
            
            // Calculate profit (portfolio value - cost)
            const profits = portfolioValues.map((portfolioValue, index) => {
                const cost = costs[index] || 0;
                return portfolioValue - cost;
            });
            
            // Calculate percentage change from first value for better visualization
            const firstValue = totalValues[0] || 0;
            const percentageData = totalValues.map(value => 
                firstValue > 0 ? ((value - firstValue) / firstValue) * 100 : 0
            );

            portfolioTrendChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Asset Value (Portfolio + Cash)',
                            data: totalValues,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Profit',
                            data: profits.map(profit => profit >= 0 ? profit : null),
                            type: 'bar',
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: '#10b981',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Loss',
                            data: profits.map(profit => profit < 0 ? profit : null),
                            type: 'bar',
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#374151',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const datasetLabel = context.dataset.label;
                                    
                                    // Skip null values (used for separating profit/loss datasets)
                                    if (value === null) {
                                        return null;
                                    }
                                    
                                    if (datasetLabel === 'Total Asset Value (Portfolio + Cash)') {
                                        const change = firstValue > 0 ? ((value - firstValue) / firstValue) * 100 : 0;
                                        const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
                                        return `${datasetLabel}: $${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${changeText})`;
                                    } else if (datasetLabel === 'Profit' || datasetLabel === 'Loss') {
                                        const sign = value >= 0 ? '+' : '';
                                        return `${datasetLabel}: ${sign}$${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                    }
                                    return `${datasetLabel}: $${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 11
                                },
                                maxTicksLimit: currentPortfolioPeriod <= 7 ? undefined : currentPortfolioPeriod <= 30 ? 10 : 12,
                                autoSkip: currentPortfolioPeriod <= 7 ? false : true
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US', { 
                                        minimumFractionDigits: 0, 
                                        maximumFractionDigits: 0 
                                    });
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    const sign = value >= 0 ? '+' : '';
                                    return sign + '$' + value.toLocaleString('en-US', { 
                                        minimumFractionDigits: 0, 
                                        maximumFractionDigits: 0 
                                    });
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function showPortfolioChartState(state) {
            const loading = document.getElementById('portfolioChartLoading');
            const empty = document.getElementById('portfolioChartEmpty');
            const canvas = document.getElementById('performanceChart');
            
            // Hide all states first
            loading.classList.add('hidden');
            loading.classList.remove('flex');
            empty.classList.add('hidden');
            empty.classList.remove('flex');
            canvas.style.display = 'block';
            
            switch (state) {
                case 'loading':
                    loading.classList.remove('hidden');
                    loading.classList.add('flex');
                    canvas.style.display = 'none';
                    break;
                case 'empty':
                    empty.classList.remove('hidden');
                    empty.classList.add('flex');
                    canvas.style.display = 'none';
                    if (portfolioTrendChart) {
                        portfolioTrendChart.destroy();
                        portfolioTrendChart = null;
                    }
                    break;
                case 'chart':
                    canvas.style.display = 'block';
                    break;
            }
        }

        // Sector Allocation Pie Chart - will be initialized dynamically
        let sectorChart = null;
        const sectorCtx = document.getElementById('sectorChart').getContext('2d');

        // Cumulative Return Calculator
        async function calculateCumulativeReturn() {
            if (!currentUserId) {
                alert('Please select a user first');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }

            try {
                showReturnCalculatorState('loading');

                // Check if end date is today
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                const isEndDateToday = endDate === todayString;

                // Fetch portfolio value and balance data
                const [valueResponse, balanceResponse] = await Promise.all([
                    fetch(`${API_BASE}/historical-data?user_id=${currentUserId}`),
                    fetch(`${API_BASE}/historical-balance?user_id=${currentUserId}`)
                ]);

                const valueData = await valueResponse.json();
                const balanceData = await balanceResponse.json();

                if (valueData.error || balanceData.error) {
                    throw new Error(valueData.error || balanceData.error);
                }

                // Filter data for the selected date range
                const filteredValueData = valueData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                });

                const filteredBalanceData = balanceData.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
                });

                if (filteredValueData.length === 0 || filteredBalanceData.length === 0) {
                    throw new Error('No data available for the selected date range');
                }

                // Sort by date
                filteredValueData.sort((a, b) => new Date(a.date) - new Date(b.date));
                filteredBalanceData.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Get start values from API data
                const startPortfolioValue = parseFloat(filteredValueData[0].value || filteredValueData[0].portfolio_value || 0);
                const startBalance = parseFloat(filteredBalanceData[0].value || filteredBalanceData[0].balance || 0);

                let endPortfolioValue, endBalance;

                // If end date is today, use current displayed values instead of API data
                if (isEndDateToday) {
                    // Get current values from the displayed UI elements
                    const accountBalanceText = document.getElementById('accountBalance').textContent;
                    const portfolioValueText = document.getElementById('totalValue').textContent;
                    
                    // Parse the displayed values (remove $ and commas)
                    endBalance = parseFloat(accountBalanceText.replace(/[$,]/g, '')) || 0;
                    endPortfolioValue = parseFloat(portfolioValueText.replace(/[$,]/g, '')) || 0;
                    
                    console.log('Using current displayed values for today:');
                    console.log('Current Portfolio Value:', endPortfolioValue);
                    console.log('Current Account Balance:', endBalance);
                } else {
                    // Use API data for historical dates
                    endPortfolioValue = parseFloat(filteredValueData[filteredValueData.length - 1].value || filteredValueData[filteredValueData.length - 1].portfolio_value || 0);
                    endBalance = parseFloat(filteredBalanceData[filteredBalanceData.length - 1].value || filteredBalanceData[filteredBalanceData.length - 1].balance || 0);
                }

                // Debug logging
                console.log('Start Portfolio Value:', startPortfolioValue);
                console.log('End Portfolio Value:', endPortfolioValue);
                console.log('Start Balance:', startBalance);
                console.log('End Balance:', endBalance);
                console.log('Is End Date Today:', isEndDateToday);
                console.log('Value Data Sample:', filteredValueData[0]);
                console.log('Balance Data Sample:', filteredBalanceData[0]);

                // Validate parsed values
                if (isNaN(startPortfolioValue) || isNaN(endPortfolioValue) || isNaN(startBalance) || isNaN(endBalance)) {
                    throw new Error('Invalid data format received from API');
                }

                // Calculate total values (portfolio + balance)
                const startTotalValue = startPortfolioValue + startBalance;
                const endTotalValue = endPortfolioValue + endBalance;

                // Calculate cumulative return using the new formula
                // Return = ((portfolio_value_end + balance_end) - (portfolio_value_start + balance_start)) / (portfolio_value_start + balance_start)
                const cumulativeReturn = startTotalValue > 0 ? ((endTotalValue - startTotalValue) / startTotalValue) * 100 : 0;
                const absoluteGainLoss = endTotalValue - startTotalValue;

                // Update UI
                updateReturnResults({
                    startPortfolioValue: startPortfolioValue,
                    endPortfolioValue: endPortfolioValue,
                    startBalance: startBalance,
                    endBalance: endBalance,
                    startTotalValue: startTotalValue,
                    endTotalValue: endTotalValue,
                    cumulativeReturn: cumulativeReturn,
                    absoluteGainLoss: absoluteGainLoss
                });

                showReturnCalculatorState('results');

            } catch (error) {
                console.error('Error calculating return:', error);
                alert('Error calculating return: ' + error.message);
                showReturnCalculatorState('empty');
            }
        }

        function updateReturnResults(data) {
            // Validate data before updating UI
            const startTotal = isNaN(data.startTotalValue) ? 0 : data.startTotalValue;
            const endTotal = isNaN(data.endTotalValue) ? 0 : data.endTotalValue;
            const cumulativeRet = isNaN(data.cumulativeReturn) ? 0 : data.cumulativeReturn;
            const absoluteGain = isNaN(data.absoluteGainLoss) ? 0 : data.absoluteGainLoss;

            // Update start total value (portfolio + balance)
            document.getElementById('startCost').textContent = '$' + startTotal.toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            
            // Update end total value (portfolio + balance)
            document.getElementById('endPortfolioValue').textContent = '$' + endTotal.toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });

            // Update cumulative return with color coding
            const cumulativeReturnElement = document.getElementById('cumulativeReturn');
            cumulativeReturnElement.textContent = (cumulativeRet >= 0 ? '+' : '') + cumulativeRet.toFixed(2) + '%';
            cumulativeReturnElement.className = 'text-4xl font-bold mb-4 ' + (cumulativeRet >= 0 ? 'text-emerald-600' : 'text-red-600');

            // Update absolute gain/loss with color coding
            const absoluteGainLossElement = document.getElementById('absoluteGainLoss');
            absoluteGainLossElement.textContent = (absoluteGain >= 0 ? '+' : '') + '$' + Math.abs(absoluteGain).toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            absoluteGainLossElement.className = 'text-lg font-bold ' + (absoluteGain >= 0 ? 'text-emerald-600' : 'text-red-600');
        }

        function showReturnCalculatorState(state) {
            const loading = document.getElementById('returnCalculatorLoading');
            const results = document.getElementById('returnResults');
            const empty = document.getElementById('returnCalculatorEmpty');

            // Hide all states first
            loading.classList.add('hidden');
            loading.classList.remove('flex');
            results.classList.add('hidden');
            empty.classList.add('hidden');
            empty.classList.remove('flex');

            switch (state) {
                case 'loading':
                    loading.classList.remove('hidden');
                    loading.classList.add('flex');
                    break;
                case 'results':
                    results.classList.remove('hidden');
                    break;
                case 'empty':
                    empty.classList.remove('hidden');
                    empty.classList.add('flex');
                    break;
            }
        }

        function resetCumulativeReturnCalculator() {
            // Hide results and show empty state
            showReturnCalculatorState('empty');
            
            // Reset the form values to default (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            // Clear any previous results
            document.getElementById('cumulativeReturn').textContent = '0.00%';
            document.getElementById('cumulativeReturn').className = 'text-4xl font-bold mb-4 text-slate-900';
        }

        function reset24hChangeBlock() {
            // Reset 24h change block to default values while new data loads
            const changeValueElement = document.getElementById('change24h');
            const changePercentElement = document.getElementById('changeRate24h');
            
            if (changeValueElement) {
                changeValueElement.className = 'text-3xl font-bold text-slate-400';
                changeValueElement.textContent = '$0.00';
            }
            
            if (changePercentElement) {
                changePercentElement.className = 'text-slate-400 text-sm font-medium mt-1';
                changePercentElement.textContent = '0.00%';
            }
        }

        function resetPortfolioSummary() {
            // Reset all portfolio summary cards to default values while new data loads
            document.getElementById('accountBalance').textContent = '$0.00';
            document.getElementById('totalValue').textContent = '$0.00';
            
            const totalAssetsElement = document.querySelector('.grid .bg-white:nth-child(4) .text-3xl');
            if (totalAssetsElement) totalAssetsElement.textContent = '0';
        }

        // Add some interactivity to the table rows
        document.addEventListener('DOMContentLoaded', function() {
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8fafc';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });

            // Simulate real-time price updates (only for portfolio table, not transaction table)
            function updatePrices() {
                // Only target the portfolio/wallet table, not the transaction table
                const portfolioTable = document.querySelector('table:not(#transactionsTable)');
                if (portfolioTable) {
                    const priceElements = portfolioTable.querySelectorAll('tbody tr td:nth-child(5) div');
                    priceElements.forEach(element => {
                        const currentPrice = parseFloat(element.textContent.replace('$', '').replace(',', ''));
                        if (!isNaN(currentPrice) && currentPrice > 0) {
                            const change = (Math.random() - 0.5) * 0.02; // ±1% change
                            const newPrice = currentPrice * (1 + change);
                            element.textContent = '$' + newPrice.toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    });
                }
            }

            // Update prices every 30 seconds
            setInterval(updatePrices, 30000);

            // Add event listener for calculate return button
            const calculateReturnBtn = document.getElementById('calculateReturnBtn');
            if (calculateReturnBtn) {
                calculateReturnBtn.addEventListener('click', calculateCumulativeReturn);
            }

            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        });

        // Add smooth scrolling for better UX
        document.documentElement.style.scrollBehavior = 'smooth';
    </script>
</body>
</html>