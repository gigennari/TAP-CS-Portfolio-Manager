<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Trading - Homebroker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/config.js"></script>
    <script src="market-banner.js"></script>
    <style>
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stock-card {
            transition: all 0.3s ease;
        }
        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Stock Trading</h1>
                <p class="text-slate-600 mt-1">Search and trade stocks with real-time data</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Navigation Menu -->
                <nav class="flex items-center space-x-4 mr-6">
                    <a href="portfoliotable.html" class="px-4 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors font-medium">
                        Portfolio
                    </a>
                    <a href="homebroker.html" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium">
                        Homebroker
                    </a>
                    <a href="news.html" class="px-4 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors font-medium">
                        News
                    </a>
                </nav>
                <!-- User Selection -->
                <div class="relative">
                    <button 
                        id="userDropdownBtn" 
                        class="flex items-center space-x-2 bg-white border border-slate-300 hover:bg-slate-50 rounded-lg px-3 py-2 transition-colors"
                    >
                        <div class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <span class="text-sm font-medium text-slate-900" id="selectedUserName">Select User</span>
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div 
                        id="userDropdownMenu" 
                        class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-slate-200 z-50 hidden"
                    >
                        <div class="p-3 border-b border-slate-200">
                            <h3 class="text-sm font-medium text-slate-900">Select User</h3>
                        </div>
                        <div id="usersList" class="max-h-48 overflow-y-auto">
                            <div class="p-4 text-center text-slate-500">
                                <div class="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                                <span class="text-sm">Loading users...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <a href="portfoliotable.html" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors font-medium">
                    ← Back to Portfolio
                </a>
            </div>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-slate-900 mb-4">Search Stocks</h2>
            <div class="relative">
                <div class="flex items-center space-x-4">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="stockSearch" 
                            placeholder="Search for stocks (e.g., AAPL, MSFT, TSLA...)" 
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-colors"
                        >
                        <div id="searchResults" class="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-lg mt-1 shadow-lg z-10 hidden search-results">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>
                    <button 
                        id="searchBtn" 
                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <span>Search</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stock Information Section -->
        <div id="stockInfo" class="hidden">
            <!-- Stock Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-2xl shadow-lg p-6 stock-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Current Price</p>
                            <p class="text-2xl font-bold text-slate-900" id="currentPrice">$0.00</p>
                            <p class="text-sm font-medium mt-1" id="priceChange">+0.00 (0.00%)</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 stock-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Market Cap</p>
                            <p class="text-2xl font-bold text-slate-900" id="marketCap">$0</p>
                            <p class="text-slate-500 text-sm font-medium mt-1">Total Value</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 stock-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm font-medium">P/E Ratio</p>
                            <p class="text-2xl font-bold text-slate-900" id="peRatio">0.00</p>
                            <p class="text-slate-500 text-sm font-medium mt-1">Price/Earnings</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 stock-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-500 text-sm font-medium">Volume</p>
                            <p class="text-2xl font-bold text-slate-900" id="volume">0</p>
                            <p class="text-slate-500 text-sm font-medium mt-1">Daily Volume</p>
                        </div>
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Stock Chart -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-slate-900" id="stockTitle">Stock Performance</h3>
                            <p class="text-slate-600" id="stockSymbol">Select a stock to view chart</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg font-medium period-btn" data-period="1D">1D</button>
                            <button class="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg period-btn" data-period="5D">5D</button>
                            <button class="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg period-btn" data-period="1M">1M</button>
                            <button class="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg period-btn" data-period="3M">3M</button>
                            <button class="px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg period-btn" data-period="1Y">1Y</button>
                        </div>
                    </div>
                    <div class="h-96">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>

                <!-- Trading Panel -->
                <div class="space-y-6">
                    <!-- Stock Details -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-slate-900 mb-4">Stock Details</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Company:</span>
                                <span class="font-medium text-slate-900" id="companyName">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Sector:</span>
                                <span class="font-medium text-slate-900" id="sector">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Industry:</span>
                                <span class="font-medium text-slate-900" id="industry">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">52W High:</span>
                                <span class="font-medium text-slate-900" id="high52">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">52W Low:</span>
                                <span class="font-medium text-slate-900" id="low52">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Dividend Yield:</span>
                                <span class="font-medium text-slate-900" id="dividendYield">0.00%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Form -->
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-slate-900 mb-4">Trade Stock</h3>
                        <form id="tradeForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Action</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" id="buyBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                        Buy
                                    </button>
                                    <button type="button" id="sellBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                                        Sell
                                    </button>
                                </div>
                                <!-- Holdings Info for Sell Orders -->
                                <div id="holdingsInfo" class="hidden mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-amber-800">Your Holdings:</span>
                                        <span class="text-sm font-bold text-amber-900" id="currentHoldings">Loading...</span>
                                    </div>
                                </div>
                                <!-- Balance Info for Buy Orders -->
                                <div id="balanceInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="space-y-1">
                                        <div class="flex items-center space-x-2">
                                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                            <span class="text-sm font-medium text-green-800">Available Balance:</span>
                                            <span class="text-sm font-bold text-green-900" id="currentBalance">Loading...</span>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-6">
                                            <span class="text-xs font-medium text-green-700">Max affordable:</span>
                                            <span class="text-xs font-bold text-green-800" id="maxAffordable">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-slate-700 mb-2">Quantity</label>
                                <input 
                                    type="number" 
                                    id="quantity" 
                                    min="0.001" 
                                    step="0.001" 
                                    placeholder="Enter quantity"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                                >
                            </div>
                            

                            
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <div class="flex justify-between text-sm">
                                    <span class="text-slate-600">Estimated Total:</span>
                                    <span class="font-medium text-slate-900" id="estimatedTotal">$0.00</span>
                                </div>
                            </div>
                            
                            <button 
                                type="submit" 
                                id="submitTradeBtn"
                                class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                Place Order
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <div class="loading-spinner"></div>
                <span class="text-slate-700">Loading stock data...</span>
            </div>
        </div>
    </div>

    <script>
        console.log('JS loaded');
        // Configuration - loaded from config.js
        const API_BASE = CONFIG.API_BASE;
        const ALPHA_VANTAGE_API_KEY = CONFIG.ALPHA_VANTAGE_API_KEY;
        const ALPHA_VANTAGE_BASE_URL = CONFIG.ALPHA_VANTAGE_BASE_URL;

        // Global variables
        let currentStock = null;
        let stockChart = null;
        let tradeAction = 'buy';
        let currentUserId = null;
        let currentUser = null;

        // DOM elements
        const stockSearch = document.getElementById('stockSearch');
        const searchResults = document.getElementById('searchResults');
        const searchBtn = document.getElementById('searchBtn');
        const stockInfo = document.getElementById('stockInfo');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        const quantity = document.getElementById('quantity');
        const estimatedTotal = document.getElementById('estimatedTotal');
        const submitTradeBtn = document.getElementById('submitTradeBtn');

        // User Management Functions
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const data = await response.json();
                
                if (data.users) {
                    populateUsersDropdown(data.users);
                } else {
                    console.error('No users data received');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showUserError('Failed to load users');
            }
        }

        function populateUsersDropdown(users) {
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="p-4 text-center text-slate-500">
                        <span class="text-sm">No users found</span>
                    </div>
                `;
                return;
            }

            const usersHTML = users.map(user => `
                <div class="user-item p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0" 
                     onclick="selectUser(${user.id}, '${user.username}', '${user.email}', '${user.name}')">
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-xs font-medium">
                                ${(user.name || user.username || 'U').charAt(0).toUpperCase()}
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-slate-900">
                                ${user.name || user.username}
                            </div>
                            <div class="text-xs text-slate-500 truncate">${user.email}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            usersList.innerHTML = usersHTML;
            
            // Auto-select user if specified in URL parameters
            if (window.autoSelectUserId) {
                const targetUser = users.find(user => user.id == window.autoSelectUserId);
                if (targetUser) {
                    selectUser(targetUser.id, targetUser.username, targetUser.email, targetUser.name);
                    // Clear the auto-select flag
                    window.autoSelectUserId = null;
                }
            } else {
                // Auto-select user with ID = 1 if available (default user)
                const defaultUser = users.find(user => user.id == 1);
                if (defaultUser) {
                    selectUser(defaultUser.id, defaultUser.username, defaultUser.email, defaultUser.name);
                }
            }
        }

        function selectUser(userId, username, email, name) {
            currentUserId = userId;
            currentUser = {
                user_id: userId,
                username: username,
                email: email,
                name: name
            };

            // Update UI
            const displayName = name || username;
            document.getElementById('selectedUserName').textContent = displayName;

            // Close dropdown
            document.getElementById('userDropdownMenu').classList.add('hidden');
            
            console.log('Selected user for trading:', currentUser);
        }

        function showUserError(message) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = `
                <div class="p-4 text-center text-red-500">
                    <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm">${message}</span>
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Validate configuration
            validateConfig();
            
            setupEventListeners();
            initializeChart();
            loadUsers();
            
            // Check for stock symbol in URL parameters
            checkUrlParameters();
        });
        
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const symbol = urlParams.get('symbol');
            const name = urlParams.get('name');
            const userId = urlParams.get('user_id');
            const action = urlParams.get('action');
            
            // Store the user ID to auto-select after users are loaded
            if (userId) {
                window.autoSelectUserId = userId;
            }
            
            // Store the action to auto-select after stock is loaded
            if (action && (action === 'buy' || action === 'sell')) {
                window.autoSelectAction = action;
            }
            
            if (symbol) {
                // Set the search input with the stock info
                if (name) {
                    stockSearch.value = `${symbol} - ${name}`;
                } else {
                    stockSearch.value = symbol;
                }
                
                // Load the stock data automatically
                loadStockData(symbol.toUpperCase());
            }
        }

        function setupEventListeners() {
            // Search functionality
            stockSearch.addEventListener('input', debounce(handleSearchInput, CONFIG.SEARCH_DEBOUNCE_MS));
            searchBtn.addEventListener('click', handleSearch);
            stockSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
            
            // Trading form
            buyBtn.addEventListener('click', () => setTradeAction('buy'));
            sellBtn.addEventListener('click', () => setTradeAction('sell'));
            quantity.addEventListener('input', updateEstimatedTotal);
            document.getElementById('tradeForm').addEventListener('submit', handleTradeSubmit);
            
            // Period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.className = 'px-3 py-1 text-sm text-slate-500 hover:bg-slate-100 rounded-lg period-btn';
                    });
                    this.className = 'px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded-lg font-medium period-btn';
                    if (currentStock) {
                        loadStockChart(currentStock.symbol, this.dataset.period);
                    }
                });
            });
            
            // Click outside to close search results
            document.addEventListener('click', function(e) {
                if (!stockSearch.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
            
            // User dropdown event listeners
            const userDropdownBtn = document.getElementById('userDropdownBtn');
            const userDropdownMenu = document.getElementById('userDropdownMenu');

            if (userDropdownBtn && userDropdownMenu) {
                userDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdownMenu.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!userDropdownBtn.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                        userDropdownMenu.classList.add('hidden');
                    }
                });

                // Prevent dropdown from closing when clicking inside
                userDropdownMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function handleSearchInput() {
            const query = stockSearch.value.trim();
            if (query.length < CONFIG.MIN_SEARCH_LENGTH) {
                searchResults.classList.add('hidden');
                return;
            }
            
            // Show loading indicator
            searchResults.innerHTML = `
                <div class="px-4 py-3 flex items-center space-x-2">
                    <div class="loading-spinner"></div>
                    <span class="text-slate-600 text-sm">Searching stocks...</span>
                </div>
            `;
            searchResults.classList.remove('hidden');
            
            try {
                // Try Alpha Vantage API first
                const results = await searchStocksAlphaVantage(query);
                if (results && results.length > 0) {
                    displaySearchResults(results);
                } else {
                    // Fallback to backend API
                    try {
                        const response = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}`);
                        const data = await response.json();
                        
                        if (data.results && data.results.length > 0) {
                            displaySearchResults(data.results);
                        } else {
                            // Final fallback to mock data
                            const mockResults = await mockSearchStocks(query);
                            displaySearchResults(mockResults);
                        }
                    } catch (backendError) {
                        console.warn('Backend API unavailable, using mock data:', backendError);
                        const mockResults = await mockSearchStocks(query);
                        displaySearchResults(mockResults);
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                // Fallback to mock data
                const results = await mockSearchStocks(query);
                displaySearchResults(results);
            }
        }

        async function searchStocksAlphaVantage(query) {
            try {
                // Check if API key is configured
                if (ALPHA_VANTAGE_API_KEY != CONFIG.ALPHA_VANTAGE_API_KEY) {
                    console.warn('Alpha Vantage API key not configured. Using fallback.');
                    return null;
                }
                
                // Alpha Vantage SYMBOL_SEARCH endpoint
                const url = `${CONFIG.ALPHA_VANTAGE_BASE_URL}?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(query)}&apikey=${CONFIG.ALPHA_VANTAGE_API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Check for API errors
                if (data['Error Message']) {
                    console.error('Alpha Vantage API Error:', data['Error Message']);
                    return null;
                }
                
                if (data['Note']) {
                    console.warn('Alpha Vantage API Note:', data['Note']);
                    return null;
                }
                
                // Parse the results
                if (data['bestMatches'] && Array.isArray(data['bestMatches'])) {
                    return data['bestMatches'].map(match => ({
                        symbol: match['1. symbol'] || '',
                        name: match['2. name'] || '',
                        type: match['3. type'] || 'Equity',
                        region: match['4. region'] || '',
                        marketOpen: match['5. marketOpen'] || '',
                        marketClose: match['6. marketClose'] || '',
                        timezone: match['7. timezone'] || '',
                        currency: match['8. currency'] || 'USD',
                        matchScore: match['9. matchScore'] || '0.0000'
                    })).slice(0, CONFIG.MAX_SEARCH_RESULTS);
                }
                
                return [];
                
            } catch (error) {
                console.error('Alpha Vantage API request failed:', error);
                return null;
            }
        }

        async function mockSearchStocks(query) {
            // Enhanced mock data for demonstration when API is unavailable
            const mockStocks = [
                { symbol: 'AAPL', name: 'Apple Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'MSFT', name: 'Microsoft Corporation', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'GOOGL', name: 'Alphabet Inc. Class A', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'TSLA', name: 'Tesla Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'META', name: 'Meta Platforms Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'NVDA', name: 'NVIDIA Corporation', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'NFLX', name: 'Netflix Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'AMD', name: 'Advanced Micro Devices Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'INTC', name: 'Intel Corporation', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'CRM', name: 'Salesforce Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'ORCL', name: 'Oracle Corporation', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'ADBE', name: 'Adobe Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'PYPL', name: 'PayPal Holdings Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'DIS', name: 'The Walt Disney Company', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'UBER', name: 'Uber Technologies Inc.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'SPOT', name: 'Spotify Technology S.A.', type: 'Equity', region: 'United States', currency: 'USD' },
                { symbol: 'ZOOM', name: 'Zoom Video Communications Inc.', type: 'Equity', region: 'United States', currency: 'USD' }
            ];
            
            return mockStocks.filter(stock => 
                stock.symbol.toLowerCase().includes(query.toLowerCase()) ||
                stock.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, CONFIG.MAX_SEARCH_RESULTS);
        }

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="px-4 py-3 text-slate-500 text-sm">No results found</div>';
                searchResults.classList.remove('hidden');
                return;
            }
            
            const html = results.map(stock => {
                // Handle both Alpha Vantage and mock data formats
                const region = stock.region ? ` • ${stock.region}` : '';
                const currency = stock.currency && stock.currency !== 'USD' ? ` (${stock.currency})` : '';
                const matchScore = stock.matchScore ? parseFloat(stock.matchScore) : 1.0;
                
                return `
                    <div class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-b-0" 
                            onclick="selectStock('${stock.symbol}', '${stock.name.replace(/'/g, "\\'")}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-slate-900">${stock.symbol}</div>
                                <div class="text-sm text-slate-600 truncate">${stock.name}</div>
                                <div class="text-xs text-slate-400 mt-1">
                                    ${stock.type}${region}${currency}
                                    ${matchScore < 1.0 ? ` • Match: ${(matchScore * 100).toFixed(0)}%` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col items-end text-xs text-slate-500 ml-2">
                                <span class="font-medium">${stock.type}</span>
                                ${stock.region ? `<span class="mt-1">${stock.region}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            searchResults.innerHTML = html;
            searchResults.classList.remove('hidden');
        }

        async function selectStock(symbol, name) {
            searchResults.classList.add('hidden');
            stockSearch.value = `${symbol} - ${name}`;
            await loadStockData(symbol);
        }

        async function handleSearch() {
            const query = stockSearch.value.trim().split(' ')[0]; // Get symbol part
            if (query) {
                await loadStockData(query.toUpperCase());
            }
        }

        async function loadStockData(symbol) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/stock/${symbol}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stockData = await response.json();
                currentStock = stockData;
                
                displayStockInfo(stockData);
                console.log('Loaded stock data:', stockData);
                await loadStockChart(symbol, '1D');
                
                stockInfo.classList.remove('hidden');
                submitTradeBtn.disabled = false;
                
            } catch (error) {
                console.error('Error loading stock data:', error);
                
                // Fallback to mock data
                try {
                    const stockData = await mockGetStockData(symbol);
                    currentStock = stockData;
                    displayStockInfo(stockData);
                    await loadStockChart(symbol, '1D');
                    stockInfo.classList.remove('hidden');
                    submitTradeBtn.disabled = false;
                } catch (mockError) {
                    alert('Error loading stock data. Please try again.');
                }
            } finally {
                showLoading(false);
            }
        }

        async function mockGetStockData(symbol) {
            // Mock data for demonstration - using more realistic base prices for major stocks
            const basePrices = {
                'AAPL': 175,
                'MSFT': 380,
                'GOOGL': 140,
                'AMZN': 145,
                'TSLA': 240,
                'META': 320,
                'NVDA': 480,
                'NFLX': 450,
                'AMD': 140,
                'INTC': 45
            };
            
            // Get a realistic base price for the stock
            const basePrice = basePrices[symbol] || 100;
            
            // Add some realistic variation (±5%)
            const priceVariation = (Math.random() - 0.5) * 0.1; // ±5%
            const currentPrice = basePrice * (1 + priceVariation);
            
            // Calculate realistic change (±3%)
            const change = (Math.random() - 0.5) * currentPrice * 0.06; // ±3% of current price
            const changePercent = (change / currentPrice) * 100;
            
            // More realistic market cap based on current price and typical shares outstanding
            const sharesOutstanding = {
                'AAPL': 15500000000,    // ~15.5B shares
                'MSFT': 7400000000,     // ~7.4B shares  
                'GOOGL': 12600000000,   // ~12.6B shares
                'AMZN': 10700000000,    // ~10.7B shares
                'TSLA': 3200000000,     // ~3.2B shares
                'META': 2600000000,     // ~2.6B shares
                'NVDA': 2500000000,     // ~2.5B shares
                'NFLX': 440000000,      // ~440M shares
                'AMD': 1600000000,      // ~1.6B shares
                'INTC': 4200000000      // ~4.2B shares
            };
            
            const shares = sharesOutstanding[symbol] || 1000000000; // Default 1B shares
            const marketCap = currentPrice * shares;
            
            // More realistic P/E ratios for different sectors
            const peRatios = {
                'AAPL': 25 + Math.random() * 10,    // 25-35
                'MSFT': 28 + Math.random() * 8,     // 28-36
                'GOOGL': 20 + Math.random() * 10,   // 20-30
                'AMZN': 40 + Math.random() * 20,    // 40-60
                'TSLA': 50 + Math.random() * 30,    // 50-80
                'META': 15 + Math.random() * 10,    // 15-25
                'NVDA': 60 + Math.random() * 20,    // 60-80
                'NFLX': 30 + Math.random() * 15,    // 30-45
                'AMD': 35 + Math.random() * 15,     // 35-50
                'INTC': 12 + Math.random() * 8      // 12-20
            };
            
            // More realistic volume ranges
            const volumeRanges = {
                'AAPL': 50000000 + Math.random() * 50000000,    // 50-100M
                'MSFT': 20000000 + Math.random() * 30000000,    // 20-50M
                'GOOGL': 15000000 + Math.random() * 20000000,   // 15-35M
                'AMZN': 25000000 + Math.random() * 25000000,    // 25-50M
                'TSLA': 80000000 + Math.random() * 70000000,    // 80-150M
                'META': 15000000 + Math.random() * 20000000,    // 15-35M
                'NVDA': 30000000 + Math.random() * 40000000,    // 30-70M
                'NFLX': 5000000 + Math.random() * 10000000,     // 5-15M
                'AMD': 40000000 + Math.random() * 40000000,     // 40-80M
                'INTC': 20000000 + Math.random() * 30000000     // 20-50M
            };

            const mockData = {
                symbol: symbol,
                name: getCompanyName(symbol),
                currentPrice: currentPrice,
                change: change,
                changePercent: changePercent,
                marketCap: marketCap,
                peRatio: peRatios[symbol] || (15 + Math.random() * 20), // Default 15-35
                volume: volumeRanges[symbol] || (10000000 + Math.random() * 40000000), // Default 10-50M
                sector: getSector(symbol),
                industry: getIndustry(symbol),
                fiftyTwoWeekHigh: currentPrice * (1.2 + Math.random() * 0.3), // 20-50% higher than current
                fiftyTwoWeekLow: currentPrice * (0.6 + Math.random() * 0.2),  // 20-40% lower than current
                dividendYield: Math.random() * 3 // 0-3% dividend yield
            };
            
            return mockData;
        }

        function getCompanyName(symbol) {
            const names = {
                'AAPL': 'Apple Inc.',
                'MSFT': 'Microsoft Corporation',
                'GOOGL': 'Alphabet Inc.',
                'AMZN': 'Amazon.com Inc.',
                'TSLA': 'Tesla Inc.',
                'META': 'Meta Platforms Inc.',
                'NVDA': 'NVIDIA Corporation',
                'NFLX': 'Netflix Inc.',
                'AMD': 'Advanced Micro Devices Inc.',
                'INTC': 'Intel Corporation'
            };
            return names[symbol] || `${symbol} Corporation`;
        }

        function getSector(symbol) {
            const sectors = {
                'AAPL': 'Technology',
                'MSFT': 'Technology',
                'GOOGL': 'Technology',
                'AMZN': 'Consumer Discretionary',
                'TSLA': 'Consumer Discretionary',
                'META': 'Technology',
                'NVDA': 'Technology',
                'NFLX': 'Communication Services',
                'AMD': 'Technology',
                'INTC': 'Technology'
            };
            return sectors[symbol] || 'Technology';
        }

        function getIndustry(symbol) {
            const industries = {
                'AAPL': 'Consumer Electronics',
                'MSFT': 'Software',
                'GOOGL': 'Internet Content & Information',
                'AMZN': 'Internet Retail',
                'TSLA': 'Auto Manufacturers',
                'META': 'Internet Content & Information',
                'NVDA': 'Semiconductors',
                'NFLX': 'Entertainment',
                'AMD': 'Semiconductors',
                'INTC': 'Semiconductors'
            };
            return industries[symbol] || 'Software';
        }

        function displayStockInfo(data) {
            document.getElementById('currentPrice').textContent = `$${data.currentPrice.toFixed(2)}`;
            document.getElementById('priceChange').textContent = 
                `${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)} (${data.changePercent.toFixed(2)}%)`;
            document.getElementById('priceChange').className = 
                `text-sm font-medium mt-1 ${data.change >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('marketCap').textContent = formatLargeNumber(data.marketCap);
            document.getElementById('peRatio').textContent = data.peRatio.toFixed(2);
            document.getElementById('volume').textContent = formatLargeNumber(data.volume);
            
            document.getElementById('stockTitle').textContent = `${data.name} (${data.symbol})`;
            document.getElementById('stockSymbol').textContent = `${data.symbol} Stock Performance`;
            
            document.getElementById('companyName').textContent = data.name;
            document.getElementById('sector').textContent = data.sector;
            document.getElementById('industry').textContent = data.industry;
            document.getElementById('high52').textContent = `$${(data.fiftyTwoWeekHigh || 0).toFixed(2)}`;
            document.getElementById('low52').textContent = `$${(data.fiftyTwoWeekLow || 0).toFixed(2)}`;
            document.getElementById('dividendYield').textContent = `${((data.dividendYield || 0) / 100).toFixed(2)}%`;
            
            // Auto-select buy/sell action if specified in URL parameters or maintain current selection
            if (window.autoSelectAction) {
                setTradeAction(window.autoSelectAction);
                // Don't clear the flag - keep the action persistent for subsequent stock searches
            } else if (!tradeAction) {
                // If no action is selected yet, default to 'buy'
                setTradeAction('buy');
            }
        }

        function formatLargeNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        function initializeChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Stock Price',
                        data: [],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#374151',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return `Price: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                color: '#f1f5f9'
                            },
                            ticks: {
                                color: '#64748b',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        async function loadStockChart(symbol, period) {
            if (!stockChart) return;
            
            try {
                const response = await fetch(`${API_BASE}/stock/${symbol}/history?frontend_period=${period}`);
                
                if (response.ok) {
                    const chartData = await response.json();
                    stockChart.data.labels = chartData.labels;
                    stockChart.data.datasets[0].data = chartData.data;
                    stockChart.update();
                } else {
                    // Fallback to mock data
                    const chartData = generateMockChartData(period);
                    stockChart.data.labels = chartData.labels;
                    stockChart.data.datasets[0].data = chartData.data;
                    stockChart.update();
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
                // Fallback to mock data
                const chartData = generateMockChartData(period);
                stockChart.data.labels = chartData.labels;
                stockChart.data.datasets[0].data = chartData.data;
                stockChart.update();
            }
        }

        function generateMockChartData(period) {
            const periods = {
                '1D': { points: 24, interval: 'hour' },
                '5D': { points: 5, interval: 'day' },
                '1M': { points: 30, interval: 'day' },
                '3M': { points: 90, interval: 'day' },
                '1Y': { points: 365, interval: 'day' }
            };
            
            const config = periods[period] || periods['1D'];
            const labels = [];
            const data = [];
            const currentPrice = currentStock ? currentStock.currentPrice : 100;
            
            // Generate historical prices that lead to the current price
            for (let i = 0; i < config.points; i++) {
                const date = new Date();
                if (config.interval === 'hour') {
                    date.setHours(date.getHours() - (config.points - i));
                    labels.push(date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                } else {
                    date.setDate(date.getDate() - (config.points - i));
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                }
                
                // Generate realistic price movement that converges to current price
                const volatility = 0.02; // 2% volatility
                const progressToPresent = i / (config.points - 1); // 0 to 1
                
                // Start from a base price and gradually move toward current price
                const startPrice = currentPrice * (0.95 + Math.random() * 0.1); // Start within ±5% of current
                const targetPrice = currentPrice;
                
                // Interpolate between start and target with some random walk
                const baseInterpolation = startPrice + (targetPrice - startPrice) * progressToPresent;
                const randomWalk = (Math.random() - 0.5) * volatility * currentPrice * (1 - progressToPresent * 0.5);
                
                let price;
                if (i === config.points - 1) {
                    // Last point should be exactly the current price
                    price = currentPrice;
                } else {
                    price = baseInterpolation + randomWalk;
                    // Ensure price doesn't go negative or too extreme
                    price = Math.max(price, currentPrice * 0.5);
                    price = Math.min(price, currentPrice * 1.5);
                }
                
                data.push(price);
            }
            
            return { labels, data };
        }

        function setTradeAction(action) {
            tradeAction = action;
            // Persist the action selection for subsequent stock searches
            window.autoSelectAction = action;
            
            const holdingsInfo = document.getElementById('holdingsInfo');
            const balanceInfo = document.getElementById('balanceInfo');
            
            if (action === 'buy') {
                buyBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium';
                sellBtn.className = 'px-4 py-2 bg-slate-300 text-slate-700 rounded-lg hover:bg-slate-400 transition-colors font-medium';
                // Hide holdings info and show balance info for buy orders
                holdingsInfo.classList.add('hidden');
                if (currentStock && currentUserId) {
                    balanceInfo.classList.remove('hidden');
                    updateCurrentBalance();
                }
            } else {
                sellBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium';
                buyBtn.className = 'px-4 py-2 bg-slate-300 text-slate-700 rounded-lg hover:bg-slate-400 transition-colors font-medium';
                // Hide balance info and show holdings info for sell orders
                balanceInfo.classList.add('hidden');
                if (currentStock && currentUserId) {
                    holdingsInfo.classList.remove('hidden');
                    updateCurrentHoldings();
                }
            }
            updateEstimatedTotal();
        }

        async function updateCurrentHoldings() {
            if (!currentStock || !currentUserId) return;
            
            const currentHoldingsElement = document.getElementById('currentHoldings');
            currentHoldingsElement.textContent = 'Loading...';
            
            try {
                const holding = await getUserStockHolding(currentUserId, currentStock.symbol);
                if (holding > 0) {
                    currentHoldingsElement.textContent = `${holding.toLocaleString()} shares`;
                    currentHoldingsElement.className = 'text-sm font-bold text-amber-900';
                } else {
                    currentHoldingsElement.textContent = 'You don\'t own any shares';
                    currentHoldingsElement.className = 'text-sm font-bold text-red-600';
                }
            } catch (error) {
                currentHoldingsElement.textContent = 'Error loading holdings';
                currentHoldingsElement.className = 'text-sm font-bold text-red-600';
            }
        }

        async function updateCurrentBalance() {
            if (!currentUserId) return;
            
            const currentBalanceElement = document.getElementById('currentBalance');
            const maxAffordableElement = document.getElementById('maxAffordable');
            currentBalanceElement.textContent = 'Loading...';
            maxAffordableElement.textContent = '-';
            
            try {
                const balance = await getUserAccountBalance(currentUserId);
                if (balance > 0) {
                    currentBalanceElement.textContent = `$${balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    currentBalanceElement.className = 'text-sm font-bold text-green-900';
                    
                    // Calculate max affordable quantity if stock is loaded
                    if (currentStock && currentStock.currentPrice > 0) {
                        const maxQuantity = balance / currentStock.currentPrice;
                        if (maxQuantity >= 0.01) {
                            maxAffordableElement.textContent = `${maxQuantity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} shares`;
                            maxAffordableElement.className = 'text-xs font-bold text-green-800';
                        } else {
                            maxAffordableElement.textContent = 'Cannot afford 0.01 shares';
                            maxAffordableElement.className = 'text-xs font-bold text-red-600';
                        }
                    }
                } else {
                    currentBalanceElement.textContent = 'Insufficient funds';
                    currentBalanceElement.className = 'text-sm font-bold text-red-600';
                    maxAffordableElement.textContent = '0 shares';
                    maxAffordableElement.className = 'text-xs font-bold text-red-600';
                }
            } catch (error) {
                currentBalanceElement.textContent = 'Error loading balance';
                currentBalanceElement.className = 'text-sm font-bold text-red-600';
                maxAffordableElement.textContent = 'Error';
                maxAffordableElement.className = 'text-xs font-bold text-red-600';
            }
        }



        function updateEstimatedTotal() {
            if (!currentStock || !quantity.value) {
                estimatedTotal.textContent = '$0.00';
                return;
            }
            
            const qty = parseFloat(quantity.value);
            const price = orderType.value === 'limit' && document.getElementById('limitPrice').value 
                ? parseFloat(document.getElementById('limitPrice').value)
                : currentStock.currentPrice;
            
            const total = qty * price;
            estimatedTotal.textContent = `$${total.toFixed(2)}`;
        }

        async function getUserStockHolding(userId, symbol) {
            try {
                const response = await fetch(`${API_BASE}/wallet?user_id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.wallet && Array.isArray(data.wallet)) {
                    const holding = data.wallet.find(stock => stock.symbol.toLowerCase() === symbol.toLowerCase());
                    return holding ? holding.quantity : 0;
                }
                return 0;
            } catch (error) {
                console.error('Error fetching user stock holding:', error);
                return 0;
            }
        }

        async function getUserAccountBalance(userId) {
            try {
                const response = await fetch(`${API_BASE}/balance?user_id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.balance || 0;
            } catch (error) {
                console.error('Error fetching user account balance:', error);
                return 0;
            }
        }

        async function handleTradeSubmit(e) {
            e.preventDefault();
            
            if (!currentStock || !quantity.value) {
                alert('Please select a stock and enter quantity');
                return;
            }
            
            if (!currentUserId) {
                alert('Please select a user before placing a trade');
                return;
            }
            
            const requestedQuantity = parseFloat(quantity.value);
            
            // Validate sell orders - check if user has enough shares
            if (tradeAction === 'sell') {
                try {
                    showLoading(true);
                    const currentHolding = await getUserStockHolding(currentUserId, currentStock.symbol);
                    showLoading(false);
                    
                    if (currentHolding === 0) {
                        alert(`❌ Cannot sell ${currentStock.symbol}\n\nYou don't own any shares of ${currentStock.symbol}.`);
                        return;
                    }
                    
                    if (currentHolding < requestedQuantity) {
                        alert(`❌ Insufficient shares to sell\n\n` +
                              `You own: ${currentHolding.toLocaleString()} shares\n` +
                              `Trying to sell: ${requestedQuantity.toLocaleString()} shares\n\n` +
                              `Please reduce the quantity to ${currentHolding.toLocaleString()} or less.`);
                        return;
                    }
                } catch (error) {
                    showLoading(false);
                    alert('❌ Error checking your stock holdings. Please try again.');
                    return;
                }
            }
            
            // Validate buy orders - check if user has enough balance
            if (tradeAction === 'buy') {
                try {
                    showLoading(true);
                    const currentBalance = await getUserAccountBalance(currentUserId);
                    showLoading(false);
                    
                    // Calculate the total cost of the purchase
                    const stockPrice = orderType.value === 'limit' && document.getElementById('limitPrice').value 
                        ? parseFloat(document.getElementById('limitPrice').value)
                        : currentStock.currentPrice;
                    const totalCost = requestedQuantity * stockPrice;
                    
                    if (currentBalance === 0) {
                        alert(`❌ Cannot buy ${currentStock.symbol}\n\nYour account balance is $0.00.`);
                        return;
                    }
                    
                    if (currentBalance < totalCost) {
                        alert(`❌ Insufficient funds to buy\n\n` +
                              `Available balance: $${currentBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n` +
                              `Total cost: $${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n` +
                              `Shortfall: $${(totalCost - currentBalance).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n\n` +
                              `Please reduce the quantity or add funds to your account.`);
                        return;
                    }
                } catch (error) {
                    showLoading(false);
                    alert('❌ Error checking your account balance. Please try again.');
                    return;
                }
            }
            
            const tradeData = {
                user_id: currentUserId,
                symbol: currentStock.symbol,
                action: tradeAction,
                quantity: requestedQuantity,
                estimatedPrice: currentStock.currentPrice
            };
            
            // Show confirmation
            const userDisplayName = currentUser.name || currentUser.username;
            
            const confirmMessage = `Confirm ${tradeAction.toUpperCase()} order:\n\n` +
                `User: ${userDisplayName}\n` +
                `Stock: ${currentStock.symbol}\n` +
                `Quantity: ${tradeData.quantity}\n` +
                `Estimated Total: ${estimatedTotal.textContent}`;
            
            if (confirm(confirmMessage)) {
                try {
                    showLoading(true);
                    
                    // Mock API call - replace with actual backend call
                    await mockExecuteTrade(tradeData);
                    
                    alert('Order placed successfully!');
                    
                    // Reset form but maintain the current action selection
                    document.getElementById('tradeForm').reset();
                    // Keep the current action (buy/sell) selected for convenience
                    setTradeAction(tradeAction);
                    estimatedTotal.textContent = '$0.00';
                    
                } catch (error) {
                    console.error('Trade execution error:', error);
                    alert('Error placing order. Please try again.');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function mockExecuteTrade(tradeData) {
            try {
                const response = await fetch(`${API_BASE}/trade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tradeData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
                
            } catch (error) {
                console.error('Trade execution error:', error);
                
                // Fallback to mock execution
                await new Promise(resolve => setTimeout(resolve, 1000));
                console.log('Trade executed (mock):', tradeData);
                return { success: true, orderId: Math.random().toString(36).substr(2, 9) };
            }
        }

        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>